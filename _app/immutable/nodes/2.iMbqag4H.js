import{f as W,a as R,t as jt,c as $t}from"../chunks/BX9JqRfx.js";import"../chunks/C_mhSzNy.js";import{a as le,Q as Ie,P as Rt,h as $,G as Ne,M as Ge,w as m,a1 as mt,S as Re,U as Ae,V as te,W as At,e as ht,ae as Oe,aD as Fe,b as Bt,s as Ve,c as Be,al as We,aG as B,ac as ee,aB as ce,k as he,aL as He,r as ue,p as Ze,aM as Ye,aN as Ue,aO as Ot,d as de,ax as Xe,aP as qe,aA as Qe,aQ as Je,I as Ke,as as je,aR as $e,aS as ti,z as ve,aH as ut,a2 as ei,F as M,D as w,a3 as D,B as j,C as pe,E as x,A as ft,u as et}from"../chunks/DaC0ZXKz.js";import{p as N,i as it,_ as ii,b as fe}from"../chunks/B19H37eM.js";import{c as me,o as ri,a as si}from"../chunks/Cv0Hl5ep.js";import{d as ge,e as oi,s as F}from"../chunks/BALP7dZq.js";import{r as rt,a as st}from"../chunks/BHoUpGYX.js";function ie(a,t){return t}function ai(a,t,e){for(var i=a.items,r=[],s=t.length,o=0;o<s;o++)qe(t[o].e,r,!0);var f=s>0&&r.length===0&&e!==null;if(f){var d=e.parentNode;Qe(d),d.append(e),i.clear(),H(a,t[0].prev,t[s-1].next)}Je(r,()=>{for(var l=0;l<s;l++){var g=t[l];f||(i.delete(g.k),H(a,g.prev,g.next)),de(g.e,!f)}})}function re(a,t,e,i,r,s=null){var o=a,f={flags:t,items:new Map,first:null};{var d=a;o=$?Rt(Ne(d)):d.appendChild(le())}$&&Ge();var l=null,g=!1,_=new Map,u=mt(()=>{var v=e();return he(v)?v:v==null?[]:ce(v)}),b,c;function h(){ni(c,b,f,_,o,r,t,i,e),s!==null&&(b.length===0?l?ue(l):l=Bt(()=>s(o)):l!==null&&Ze(l,()=>{l=null}))}Ie(()=>{c??=Ke,b=m(u);var v=b.length;if(g&&v===0)return;g=v===0;let E=!1;if($){var P=Re(o)===Ae;P!==(v===0)&&(o=te(),Rt(o),At(!1),E=!0)}if($){for(var p=null,y,T=0;T<v;T++){if(ht.nodeType===Oe&&ht.data===Fe){o=ht,E=!0,At(!1);break}var L=b[T],I=i(L,T);y=Wt(ht,f,p,null,L,I,T,r,t,e),f.items.set(I,y),p=y}v>0&&Rt(te())}if($)v===0&&s&&(l=Bt(()=>s(o)));else if(Ve()){var k=new Set,G=Be;for(T=0;T<v;T+=1){L=b[T],I=i(L,T);var Z=f.items.get(I)??_.get(I);Z?_e(Z,L,T):(y=Wt(null,f,null,null,L,I,T,r,t,e,!0),_.set(I,y)),k.add(I)}for(const[X,Y]of f.items)k.has(X)||G.skipped_effects.add(Y.e);G.oncommit(h)}else h();E&&At(!0),m(u)}),$&&(o=ht)}function ni(a,t,e,i,r,s,o,f,d){var l=t.length,g=e.items,_=e.first,u=_,b,c=null,h=[],v=[],E,P,p,y;for(y=0;y<l;y+=1){if(E=t[y],P=f(E,y),p=g.get(P),p===void 0){var T=i.get(P);if(T!==void 0){i.delete(P),g.set(P,T);var L=c?c.next:u;H(e,c,T),H(e,T,L),Ft(T,L,r),c=T}else{var I=u?u.e.nodes_start:r;c=Wt(I,e,c,c===null?e.first:c.next,E,P,y,s,o,d)}g.set(P,c),h=[],v=[],u=c.next;continue}if(_e(p,E,y),(p.e.f&Ot)!==0&&ue(p.e),p!==u){if(b!==void 0&&b.has(p)){if(h.length<v.length){var k=v[0],G;c=k.prev;var Z=h[0],X=h[h.length-1];for(G=0;G<h.length;G+=1)Ft(h[G],k,r);for(G=0;G<v.length;G+=1)b.delete(v[G]);H(e,Z.prev,X.next),H(e,c,Z),H(e,X,k),u=k,c=X,y-=1,h=[],v=[]}else b.delete(p),Ft(p,u,r),H(e,p.prev,p.next),H(e,p,c===null?e.first:c.next),H(e,c,p),c=p;continue}for(h=[],v=[];u!==null&&u.k!==P;)(u.e.f&Ot)===0&&(b??=new Set).add(u),v.push(u),u=u.next;if(u===null)continue;p=u}h.push(p),c=p,u=p.next}if(u!==null||b!==void 0){for(var Y=b===void 0?[]:ce(b);u!==null;)(u.e.f&Ot)===0&&Y.push(u),u=u.next;var ot=Y.length;if(ot>0){var tt=l===0?r:null;ai(e,Y,tt)}}a.first=e.first&&e.first.e,a.last=c&&c.e;for(var _t of i.values())de(_t.e);i.clear()}function _e(a,t,e,i){We(a.v,t),a.i=e}function Wt(a,t,e,i,r,s,o,f,d,l,g){var _=(d&Ye)!==0,u=(d&Ue)===0,b=_?u?B(r,!1,!1):ee(r):r,c=(d&He)===0?o:ee(o),h={i:c,v:b,k:s,a:null,e:null,prev:e,next:i};try{if(a===null){var v=document.createDocumentFragment();v.append(a=le())}return h.e=Bt(()=>f(a,b,c,l),$),h.e.prev=e&&e.e,h.e.next=i&&i.e,e===null?g||(t.first=h):(e.next=h,e.e.next=h.e),i!==null&&(i.prev=h,i.e.prev=h.e),h}finally{}}function Ft(a,t,e){for(var i=a.next?a.next.e.nodes_start:e,r=t?t.e.nodes_start:e,s=a.e.nodes_start;s!==null&&s!==i;){var o=Xe(s);r.before(s),s=o}}function H(a,t,e){t===null?a.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Ht(a,t,e=!1){if(a.multiple){if(t==null)return;if(!he(t))return $e();for(var i of a.options)i.selected=t.includes(oe(i));return}for(i of a.options){var r=oe(i);if(ti(r,t)){i.selected=!0;return}}(!e||t!==void 0)&&(a.selectedIndex=-1)}function se(a){var t=new MutationObserver(()=>{Ht(a,a.__value)});t.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),je(()=>{t.disconnect()})}function oe(a){return"__value"in a?a.__value:a.value}const xe={osm:{key:"osm",label:"OpenStreetMap",template:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors"},satellite:{key:"satellite",label:"ArcGIS World Imagery",template:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, Maxar, Earthstar Geographics",maxZoom:19},cartoLight:{key:"cartoLight",label:"CARTO Positron",template:"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",subdomains:["a","b","c","d"],attribution:"© OpenStreetMap contributors, © CARTO"},osmHot:{key:"osmHot",label:"OSM Humanitarian",template:"https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors, Humanitarian style"},esriTopo:{key:"esriTopo",label:"Esri World Topographic",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"},esriGray:{key:"esriGray",label:"Esri Light Gray",template:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri | Esri Light Gray Canvas"},esriStreets:{key:"esriStreets",label:"Esri World Street Map",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"}};function ae(a){return xe[a]}const gt=Object.values(xe).filter(a=>!a.requiresToken||!!a.token);var li=W("<option> </option>"),ci=W('<p class="search-error svelte-oydtmz"> </p>'),hi=W('<p class="search-message svelte-oydtmz"> </p>'),ui=W('<li><button type="button" class="svelte-oydtmz"> </button></li>'),di=W('<ul class="search-results svelte-oydtmz"></ul>'),vi=W("<div><span>Center Lat</span> <strong> </strong></div> <div><span>Center Lng</span> <strong> </strong></div>",1),pi=W("<div><span>North</span> <strong> </strong></div> <div><span>South</span> <strong> </strong></div> <div><span>West</span> <strong> </strong></div> <div><span>East</span> <strong> </strong></div>",1),fi=W('<div class="placeholder">Map loading… pan or zoom on canvas</div>'),mi=W('<section class="panel svelte-oydtmz"><header><div><h1 class="svelte-oydtmz">Export map tiles into <br/> a printable A4 grid</h1></div> <button class="export svelte-oydtmz"><!></button></header> <div class="grid svelte-oydtmz"><label class="svelte-oydtmz"><span>Rows</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Cols</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Zoom +Δ</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Orientation</span> <select class="svelte-oydtmz"><option>Portrait</option><option>Landscape</option></select></label> <label class="svelte-oydtmz"><span>Provider</span> <select class="svelte-oydtmz"></select></label> <label class="svelte-oydtmz"><span>DPI</span> <input type="number" min="72" step="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>File Prefix</span> <input type="text" class="svelte-oydtmz"/></label></div> <form class="search svelte-oydtmz"><label class="svelte-oydtmz"><span>Jump to location</span> <div class="search-row svelte-oydtmz"><input type="text" placeholder="City, address or lat,lng" class="svelte-oydtmz"/> <button type="submit" class="svelte-oydtmz"> </button></div></label> <!></form> <div class="meta svelte-oydtmz"><div><span>Zoom</span> <strong> </strong></div> <!> <!></div></section>');function gi(a,t){ve(t,!0);const e=N(t,"rows",3,2),i=N(t,"cols",3,2),r=N(t,"zoomDelta",3,1),s=N(t,"orientation",3,"portrait"),o=N(t,"provider",3,"osm"),f=N(t,"zoom",3,15),d=N(t,"viewbox",3,null),l=N(t,"center",3,null),g=N(t,"isExporting",3,!1),_=N(t,"dpi",3,300),u=N(t,"filePrefix",3,"map"),b=me();let c=ut(""),h=ut(ei([])),v=ut(!1),E=ut(""),P=ut("");function p(n,z){const S=Number.parseInt(z,10);if(Number.isNaN(S))return;const C=n==="dpi"?72:n==="zoomDelta"?0:1;b("change",{[n]:Math.max(C,S)})}function y(n){b("change",{orientation:n})}function T(n){b("change",{provider:n})}function L(n){const z=n.trim();b("change",{filePrefix:z||"map"})}function I(){b("export")}function k(n,z,S){b("locate",{lat:n,lng:z,label:S}),D(P,S?`Centered on ${S}`:`Centered on ${n.toFixed(4)}, ${z.toFixed(4)}`,!0)}function G(n){const z=n.split(/[,\s]+/).filter(Boolean);if(z.length<2)return null;const S=Number.parseFloat(z[0]),C=Number.parseFloat(z[1]);return Number.isNaN(S)||Number.isNaN(C)||S<-90||S>90||C<-180||C>180?null:{lat:S,lng:C}}async function Z(n){n?.preventDefault();const z=m(c).trim();if(D(E,""),D(h,[],!0),D(P,""),!z)return;const S=G(z);if(S){k(S.lat,S.lng);return}D(v,!0);try{const C=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=${encodeURIComponent(z)}`,{headers:{Accept:"application/json","User-Agent":"tessellate-maps/1.0 (https://github.com/giacomonanni/tessellate-maps)"}});if(!C.ok)throw new Error("Search failed");const V=await C.json();if(!V.length){D(P,"No results found."),D(v,!1);return}D(h,V,!0)}catch(C){console.error(C),D(E,"Unable to reach the geocoding service.")}D(v,!1)}function X(n){const z=Number.parseFloat(n.lat),S=Number.parseFloat(n.lon);Number.isNaN(z)||Number.isNaN(S)||(D(h,[],!0),D(c,n.display_name,!0),k(z,S,n.display_name))}var Y=mi(),ot=w(Y),tt=M(w(ot),2);tt.__click=I;var _t=w(tt);{var be=n=>{var z=jt("Exporting…");R(n,z)},ye=n=>{var z=jt("Export Grid");R(n,z)};it(_t,n=>{g()?n(be):n(ye,!1)})}x(tt),x(ot);var xt=M(ot,2),bt=w(xt),yt=M(w(bt),2);rt(yt),yt.__input=n=>p("rows",n.currentTarget.value),x(bt);var wt=M(bt,2),zt=M(w(wt),2);rt(zt),zt.__input=n=>p("cols",n.currentTarget.value),x(wt);var St=M(wt,2),Mt=M(w(St),2);rt(Mt),Mt.__input=n=>p("zoomDelta",n.currentTarget.value),x(St);var Pt=M(St,2),q=M(w(Pt),2);q.__change=n=>y(n.currentTarget.value);var Et=w(q);Et.value=Et.__value="portrait";var Zt=M(Et);Zt.value=Zt.__value="landscape",x(q);var Yt;se(q),x(Pt);var Tt=M(Pt,2),Q=M(w(Tt),2);Q.__change=n=>T(n.currentTarget.value),re(Q,21,()=>gt,ie,(n,z)=>{var S=li(),C=w(S,!0);x(S);var V={};j(()=>{F(C,m(z).label),V!==(V=m(z).key)&&(S.value=(S.__value=m(z).key)??"")}),R(n,S)}),x(Q);var Ut;se(Q),x(Tt);var Lt=M(Tt,2),Dt=M(w(Lt),2);rt(Dt),Dt.__input=n=>p("dpi",n.currentTarget.value),x(Lt);var Xt=M(Lt,2),Ct=M(w(Xt),2);rt(Ct),Ct.__input=n=>L(n.currentTarget.value),x(Xt),x(xt);var dt=M(xt,2),kt=w(dt),qt=M(w(kt),2),vt=w(qt);rt(vt),vt.__input=n=>D(c,n.currentTarget.value,!0);var It=M(vt,2),we=w(It,!0);x(It),x(qt),x(kt);var ze=M(kt,2);{var Se=n=>{var z=ci(),S=w(z,!0);x(z),j(()=>F(S,m(E))),R(n,z)},Me=n=>{var z=$t(),S=ft(z);{var C=A=>{var O=hi(),J=w(O,!0);x(O),j(()=>F(J,m(P))),R(A,O)},V=A=>{var O=$t(),J=ft(O);{var K=U=>{var at=di();re(at,21,()=>m(h),ie,(pt,nt)=>{var lt=ui(),ct=w(lt);ct.__click=()=>X(m(nt));var Gt=w(ct,!0);x(ct),x(lt),j(()=>F(Gt,m(nt).display_name)),R(pt,lt)}),x(at),R(U,at)};it(J,U=>{m(h).length&&U(K)},!0)}R(A,O)};it(S,A=>{m(P)?A(C):A(V,!1)},!0)}R(n,z)};it(ze,n=>{m(E)?n(Se):n(Me,!1)})}x(dt);var Qt=M(dt,2),Nt=w(Qt),Jt=M(w(Nt),2),Pe=w(Jt);x(Jt),x(Nt);var Kt=M(Nt,2);{var Ee=n=>{var z=vi(),S=ft(z),C=M(w(S),2),V=w(C,!0);x(C),x(S);var A=M(S,2),O=M(w(A),2),J=w(O,!0);x(O),x(A),j((K,U)=>{F(V,K),F(J,U)},[()=>l().lat.toFixed(4),()=>l().lng.toFixed(4)]),R(n,z)};it(Kt,n=>{l()&&n(Ee)})}var Te=M(Kt,2);{var Le=n=>{var z=pi(),S=ft(z),C=M(w(S),2),V=w(C,!0);x(C),x(S);var A=M(S,2),O=M(w(A),2),J=w(O,!0);x(O),x(A);var K=M(A,2),U=M(w(K),2),at=w(U,!0);x(U),x(K);var pt=M(K,2),nt=M(w(pt),2),lt=w(nt,!0);x(nt),x(pt),j((ct,Gt,Ce,ke)=>{F(V,ct),F(J,Gt),F(at,Ce),F(lt,ke)},[()=>d().n.toFixed(4),()=>d().s.toFixed(4),()=>d().w.toFixed(4),()=>d().e.toFixed(4)]),R(n,z)},De=n=>{var z=fi();R(n,z)};it(Te,n=>{d()?n(Le):n(De,!1)})}x(Qt),x(Y),j(()=>{tt.disabled=g(),st(yt,e()),st(zt,i()),st(Mt,r()),Yt!==(Yt=s())&&(q.value=(q.__value=s())??"",Ht(q,s())),Ut!==(Ut=o())&&(Q.value=(Q.__value=o())??"",Ht(Q,o())),st(Dt,_()),st(Ct,u()),st(vt,m(c)),It.disabled=m(v),F(we,m(v)?"Searching…":"Go"),F(Pe,`z${f()??""}`)}),oi("submit",dt,Z),R(a,Y),pe()}ge(["click","input","change"]);class _i{constructor(t,e){this.p=t,this.provider=ae(e),this.cache=new Map,this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.token=""}getTileSize(){return this.tileSize}setProvider(t){this.provider=ae(t),this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.cache.clear()}setApiToken(t){this.token=t,this.cache.clear()}latLngToPixel(t,e,i){const r=this.tileSize*Math.pow(2,i),s=(t+180)/360*r,o=Math.sin(e*Math.PI/180),f=(.5-Math.log((1+o)/(1-o))/(4*Math.PI))*r;return{x:s,y:f}}pixelToLatLng(t,e,i){const r=this.tileSize*Math.pow(2,i),s=t/r,o=e/r,f=s*360-180,d=Math.PI-2*Math.PI*o,l=180/Math.PI*Math.atan(.5*(Math.exp(d)-Math.exp(-d)));return{lng:f,lat:l}}getTile(t,e,i){const r=Math.pow(2,t),s=(e%r+r)%r,o=Math.max(0,Math.min(r-1,i)),f=`${this.provider.key}/${t}/${s}/${o}`,d=this.cache.get(f);if(d)return d;const l={image:null,ready:!1,failed:!1,waiters:[]};this.cache.set(f,l);const g=this.buildUrl(t,s,o);return this.p.loadImage(g,_=>{l.image=_,l.ready=!0,l.failed=!1,this.resolve(l)},()=>{l.ready=!0,l.failed=!0,this.resolve(l)}),l}resolve(t){t.waiters.length&&(t.waiters.forEach(e=>e()),t.waiters=[])}buildUrl(t,e,i){let r=this.template.replace("{z}",String(t)).replace("{x}",String(e)).replace("{y}",String(i));if(r.includes("{s}")&&this.subdomains.length){const s=Math.abs((e+i)%this.subdomains.length);r=r.replace("{s}",this.subdomains[s])}return r.includes("{token}")&&(r=r.replace("{token}",encodeURIComponent(this.token))),r}}function xi(a){return a.ready?Promise.resolve():new Promise(t=>{a.waiters.push(t)})}const ne=25.4;function bi(a,t){const e=a==="portrait"?210:297,i=a==="portrait"?297:210;return{widthPx:Math.round(e/ne*t),heightPx:Math.round(i/ne*t)}}function yi(a){return a==="portrait"?210/297:297/210}async function wi(a,t,e,i){const r=t.getTileSize(),s=t.latLngToPixel(e.w,e.n,i),o=t.latLngToPixel(e.e,e.s,i),f=Math.floor(s.x/r),d=Math.floor(o.x/r),l=Math.floor(s.y/r),g=Math.floor(o.y/r),_=s.x,u=s.y,b=Math.max(1,Math.ceil(o.x-s.x)),c=Math.max(1,Math.ceil(o.y-s.y)),h=a.createGraphics(b,c);for(let v=l;v<=g;v+=1)for(let E=f;E<=d;E+=1){const P=t.getTile(i,E,v);if(await xi(P),P.ready&&P.image){const p=E*r-_,y=v*r-u;h.image(P.image,p,y,r,r)}}return h}async function zi(a,t,e,i){const{rows:r,cols:s,zoom:o,zoomDelta:f,orientation:d,dpi:l,filePrefix:g="map"}=i,_=Math.min(19,o+f),{widthPx:u,heightPx:b}=bi(d,l);for(let c=0;c<r;c+=1)for(let h=0;h<s;h+=1){const v=c*s+h,E=e[v],P=await wi(a,t,{n:E.n,s:E.s,w:E.w,e:E.e},_),p=a.createGraphics(u,b);p.image(P,0,0,u,b);const y=`${g}_${String(c+1).padStart(2,"0")}_${String(h+1).padStart(2,"0")}_${d}_z${_}.png`;a.save(p,y),await Si(140)}}function Si(a){return new Promise(t=>setTimeout(t,a))}function Vt(a,t,e,i){const r=a.latLngToPixel(t.lng,t.lat,e),s=r.x-i.width/2,o=r.y-i.height/2,f=s+i.width,d=o+i.height,l=a.pixelToLatLng(s,o,e),g=a.pixelToLatLng(f,d,e);return{zoom:e,pixelBounds:{left:s,top:o,width:i.width,height:i.height},latLngBounds:{n:l.lat,s:g.lat,w:l.lng,e:g.lng},centerPixel:r}}function Mi(a,t,e,i){const{zoom:r,pixelBounds:s}=t,o=s.width/i,f=s.height/e,d=[];for(let l=0;l<e;l+=1)for(let g=0;g<i;g+=1){const _=s.left+g*o,u=s.top+l*f,b=_+o,c=u+f,h=a.pixelToLatLng(_,u,r),v=a.pixelToLatLng(b,c,r);d.push({n:h.lat,s:v.lat,w:h.lng,e:v.lng,row:l,col:g})}return d}class Pi{constructor(t,e={}){this.target=t,this.options={rows:e.rows??2,cols:e.cols??3,zoom:e.zoom??15,zoomDelta:e.zoomDelta??0,orientation:e.orientation??"portrait",provider:e.provider??"osm",dpi:e.dpi??300,filePrefix:e.filePrefix??"map"},this.rows=this.options.rows,this.cols=this.options.cols,this.zoom=this.options.zoom,this.zoomDelta=this.options.zoomDelta,this.orientation=this.options.orientation,this.provider=this.options.provider,this.dpi=this.options.dpi,this.filePrefix=this.options.filePrefix??"map",this.p=null,this.p5Constructor=null,this.tileSystem=null,this.viewbox=null,this.center={lat:52.52,lng:13.405},this.stateSubscribers=new Set,this.shortcutListeners=new Set,this.viewport=null}async init(){if(!this.p){if(!this.p5Constructor){const t=await ii(()=>import("../chunks/DLNX37f0.js"),[],import.meta.url);this.p5Constructor=t.default}await new Promise(t=>{if(!this.p5Constructor)return t();this.p=new this.p5Constructor(e=>this.defineSketch(e,t),this.target)})}}defineSketch(t,e){t.setup=()=>{const i=this.target.getBoundingClientRect();t.createCanvas(Math.max(1,i.width),Math.max(1,i.height)),t.pixelDensity(1),this.tileSystem=new _i(t,this.provider),this.notifyState(),e()},t.windowResized=()=>{this.resize()},t.draw=()=>{this.render(t)},t.mouseDragged=()=>{this.handleDrag(t)},t.touchMoved=()=>(this.handleDrag(t),!1),t.keyPressed=()=>{t.key==="+"||t.key==="="?this.setZoom(this.zoom+1,t.width/2,t.height/2):(t.key==="-"||t.key==="_")&&this.setZoom(this.zoom-1,t.width/2,t.height/2)}}render(t){if(!this.tileSystem)return;t.background("azure");const e=this.computeGridFrame(t.width,t.height),i=Vt(this.tileSystem,this.center,this.zoom,e);this.applyViewport(i);const r=this.tileSystem.getTileSize(),{left:s,top:o,width:f,height:d}=i.pixelBounds,l=Math.floor(s/r),g=Math.floor((s+f)/r),_=Math.floor(o/r),u=Math.floor((o+d)/r),b=t.drawingContext;b.save(),b.beginPath(),b.rect(e.left,e.top,e.width,e.height),b.clip();for(let c=_;c<=u;c+=1)for(let h=l;h<=g;h+=1){const v=this.tileSystem.getTile(this.zoom,h,c);if(v.ready&&v.image){const E=h*r-s+e.left,P=c*r-o+e.top;t.image(v.image,E,P,r,r)}}b.restore(),this.drawGrid(t,e)}drawGrid(t,e){t.stroke("blue"),t.noFill(),t.rect(e.left,e.top,e.width,e.height);const i=e.width/this.cols,r=e.height/this.rows;for(let s=0;s<=this.rows;s+=1){const o=e.top+s*r;t.line(e.left,o,e.left+e.width,o)}for(let s=0;s<=this.cols;s+=1){const o=e.left+s*i;t.line(o,e.top,o,e.top+e.height)}}handleDrag(t){if(!this.tileSystem||Array.isArray(t.touches)&&t.touches.length>1)return;const e=this.screenToWorld(t.mouseX,t.mouseY),i=this.screenToWorld(t.pmouseX,t.pmouseY);this.center.lat+=i.lat-e.lat,this.center.lng+=i.lng-e.lng,this.center.lat=this.clampLatitude(this.center.lat),this.center.lng=this.normalizeLongitude(this.center.lng),this.invalidateViewport()}setZoom(t,e,i){if(!this.tileSystem||!this.p)return;const r=Math.max(1,Math.min(19,t));if(r===this.zoom)return;const s=this.screenToWorld(e,i);this.zoom=r;const o=this.screenToWorld(e,i);this.center.lat+=s.lat-o.lat,this.center.lng+=s.lng-o.lng,this.invalidateViewport(),this.notifyState()}zoomBy(t){if(!this.p)return;const e=this.p.width/2,i=this.p.height/2;this.setZoom(this.zoom+t,e,i)}screenToWorld(t,e){if(!this.tileSystem||!this.p)return this.center;const i=this.computeGridFrame(this.p.width,this.p.height),r=this.tileSystem.latLngToPixel(this.center.lng,this.center.lat,this.zoom),s=t-i.left,o=e-i.top,f=r.x-i.width/2+s,d=r.y-i.height/2+o;return this.tileSystem.pixelToLatLng(f,d,this.zoom)}cycleProvider(){const t=gt.findIndex(i=>i.key===this.provider),e=gt[(t+1)%gt.length];this.setProvider(e.key)}resize(t,e){if(!this.p)return;const i=this.target.getBoundingClientRect(),r=Math.max(1,t??i.width),s=Math.max(1,e??i.height);this.p.resizeCanvas(r,s),this.invalidateViewport()}applyViewport(t){this.viewport=t,this.viewbox={...t.latLngBounds},this.notifyState()}invalidateViewport(){this.viewport=null,this.viewbox=null}updateViewbox(t){if(!this.tileSystem||!this.p)return;let e=t;if(!e){const i=this.computeGridFrame(this.p.width,this.p.height);e=Vt(this.tileSystem,this.center,this.zoom,i)}this.applyViewport(e)}async exportGrid(){if(!this.tileSystem||!this.p)return;let t=this.viewport;if(!t){const i=this.computeGridFrame(this.p.width,this.p.height);t=Vt(this.tileSystem,this.center,this.zoom,i),this.applyViewport(t)}const e=Mi(this.tileSystem,t,this.rows,this.cols);await zi(this.p,this.tileSystem,e,{rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,orientation:this.orientation,dpi:this.dpi,filePrefix:this.filePrefix})}setCenter(t,e,i){const r=this.clampLatitude(t),s=this.normalizeLongitude(e);this.center.lat=r,this.center.lng=s,typeof i=="number"&&(this.zoom=Math.max(1,Math.min(19,Math.round(i)))),this.invalidateViewport(),this.notifyState()}subscribe(t){return this.stateSubscribers.add(t),t(this.snapshot()),()=>{this.stateSubscribers.delete(t)}}onExportShortcut(t){return this.shortcutListeners.add(t),()=>{this.shortcutListeners.delete(t)}}triggerExportShortcut(){this.shortcutListeners.forEach(t=>t())}snapshot(){return{center:{...this.center},rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,provider:this.provider,orientation:this.orientation,viewbox:this.viewbox?{...this.viewbox}:null}}notifyState(){const t=this.snapshot();this.stateSubscribers.forEach(e=>e(t))}setGrid(t,e){const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(e));i===this.rows&&r===this.cols||(this.rows=i,this.cols=r,this.invalidateViewport(),this.notifyState())}setZoomDelta(t){const e=Math.max(0,Math.round(t));e!==this.zoomDelta&&(this.zoomDelta=e,this.notifyState())}setOrientation(t){t!==this.orientation&&(this.orientation=t,this.invalidateViewport(),this.notifyState())}setProvider(t){t!==this.provider&&(this.provider=t,this.tileSystem&&this.tileSystem.setProvider(t),this.invalidateViewport(),this.notifyState())}setDpi(t){t!==this.dpi&&(this.dpi=t)}setFilePrefix(t){this.filePrefix=t}destroy(){this.p&&this.p.remove(),this.p=null,this.tileSystem=null,this.stateSubscribers.clear(),this.shortcutListeners.clear()}getCellRatio(){return yi(this.orientation)}computeGridFrame(t,e){const i=this.getCellRatio(),r=this.cols*i/Math.max(1,this.rows);let s=t,o=s/r;o>e&&(o=e,s=o*r);const f=(t-s)/2,d=(e-o)/2;return{left:f,top:d,width:s,height:o}}clampLatitude(t){return Math.max(-85,Math.min(85,t))}normalizeLongitude(t){let e=t%360;return e>180&&(e-=360),e<-180&&(e+=360),e}}var Ei=W('<div class="map-canvas svelte-4tz69q"><div class="zoom-controls svelte-4tz69q" aria-label="Map zoom controls"><button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom in">+</button> <button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom out">-</button></div></div>');function Ti(a,t){ve(t,!0);const e=N(t,"rows",3,2),i=N(t,"cols",3,3),r=N(t,"zoomDelta",3,0),s=N(t,"orientation",3,"portrait"),o=N(t,"provider",3,"osm"),f=N(t,"dpi",3,300),d=N(t,"filePrefix",3,"map"),l=me();let g=null,_=null,u=null;ri(()=>{if(!g)return;const L=new Pi(g,{rows:e(),cols:i(),zoomDelta:r(),orientation:s(),provider:o(),dpi:f(),filePrefix:d()}),I=[];return L.init().then(()=>l("ready",L)),I.push(L.subscribe(k=>l("state",k))),I.push(L.onExportShortcut(()=>l("exportshortcut"))),u=new ResizeObserver(k=>{if(!k.length)return;const{width:G,height:Z}=k[0].contentRect;L.resize(G,Z)}),u.observe(g),_=L,()=>{I.forEach(k=>k()),u?.disconnect(),L.destroy(),_=null}}),si(()=>{u?.disconnect()}),et(()=>{_&&_.setGrid(e(),i())}),et(()=>{_&&_.setZoomDelta(r())}),et(()=>{_&&_.setOrientation(s())}),et(()=>{_&&_.setProvider(o())}),et(()=>{_&&_.setDpi(f())}),et(()=>{_&&_.setFilePrefix(d())});function b(){_?.zoomBy(1)}function c(){_?.zoomBy(-1)}async function h(){_&&await _.exportGrid()}function v(L,I,k){_?.setCenter(L,I,k)}var E={exportGrid:h,focusOn:v},P=Ei(),p=w(P),y=w(p);y.__click=b;var T=M(y,2);return T.__click=c,x(p),x(P),fe(P,L=>g=L,()=>g),R(a,P),pe(E)}ge(["click"]);var Li=W('<main class="page svelte-1uha8ag"><section class="panel svelte-1uha8ag"><!></section> <section class="canvas svelte-1uha8ag"><!></section></main>');function Ai(a){let t=B(2),e=B(2),i=B(0),r=B("portrait"),s=B("osm"),o=B(300),f=B("map"),d=B(!1),l=B(null),g=B(null);function _(p){const y=p.detail;typeof y.rows=="number"&&D(t,y.rows),typeof y.cols=="number"&&D(e,y.cols),typeof y.zoomDelta=="number"&&D(i,y.zoomDelta),y.orientation&&D(r,y.orientation),y.provider&&D(s,y.provider),typeof y.dpi=="number"&&D(o,y.dpi),y.filePrefix&&D(f,y.filePrefix)}async function u(){if(!(!m(l)||m(d))){D(d,!0);try{await m(l).exportGrid()}catch(p){console.error(p)}D(d,!1)}}function b(p){if(!m(l))return;const{lat:y,lng:T,zoom:L}=p.detail;m(l).focusOn(y,T,L)}var c=Li(),h=w(c),v=w(h);{let p=mt(()=>m(g)?.zoom??15),y=mt(()=>m(g)?.viewbox??null),T=mt(()=>m(g)?.center??null);gi(v,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get zoom(){return m(p)},get viewbox(){return m(y)},get center(){return m(T)},get isExporting(){return m(d)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{change:_,export:u,locate:b}})}x(h);var E=M(h,2),P=w(E);fe(Ti(P,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{state:p=>D(g,p.detail),exportshortcut:u},$$legacy:!0}),p=>D(l,p),()=>m(l)),x(E),x(c),R(a,c)}export{Ai as component};
