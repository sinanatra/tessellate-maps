import{f as W,a as F,t as jt,c as $t}from"../chunks/BX9JqRfx.js";import"../chunks/C_mhSzNy.js";import{a as le,Q as Ne,P as Ft,h as $,G as ke,M as Re,w as m,a1 as mt,S as Fe,U as Ge,V as te,W as Gt,e as ht,ae as Oe,aD as Ae,b as Bt,s as Ve,c as Be,al as We,aG as B,ac as ee,aB as ce,k as he,aL as Ze,r as ue,p as He,aM as Ye,aN as Xe,aO as Ot,d as de,ax as Ue,aP as qe,aA as Qe,aQ as Je,I as Ke,as as je,aR as $e,aS as ti,z as ve,aH as ut,a2 as ei,F as S,D as b,a3 as L,B as j,C as pe,E as x,A as ft,u as et}from"../chunks/DaC0ZXKz.js";import{p as k,i as it,_ as ii,b as fe}from"../chunks/B19H37eM.js";import{c as me,o as ri,a as si}from"../chunks/Cv0Hl5ep.js";import{d as ge,e as oi,s as A}from"../chunks/BALP7dZq.js";import{r as rt,a as st}from"../chunks/BHoUpGYX.js";function ie(a,t){return t}function ai(a,t,e){for(var i=a.items,r=[],s=t.length,o=0;o<s;o++)qe(t[o].e,r,!0);var f=s>0&&r.length===0&&e!==null;if(f){var d=e.parentNode;Qe(d),d.append(e),i.clear(),Z(a,t[0].prev,t[s-1].next)}Je(r,()=>{for(var l=0;l<s;l++){var g=t[l];f||(i.delete(g.k),Z(a,g.prev,g.next)),de(g.e,!f)}})}function re(a,t,e,i,r,s=null){var o=a,f={flags:t,items:new Map,first:null};{var d=a;o=$?Ft(ke(d)):d.appendChild(le())}$&&Re();var l=null,g=!1,_=new Map,u=mt(()=>{var v=e();return he(v)?v:v==null?[]:ce(v)}),w,c;function h(){ni(c,w,f,_,o,r,t,i,e),s!==null&&(w.length===0?l?ue(l):l=Bt(()=>s(o)):l!==null&&He(l,()=>{l=null}))}Ne(()=>{c??=Ke,w=m(u);var v=w.length;if(g&&v===0)return;g=v===0;let T=!1;if($){var P=Fe(o)===Ge;P!==(v===0)&&(o=te(),Ft(o),Gt(!1),T=!0)}if($){for(var p=null,y,D=0;D<v;D++){if(ht.nodeType===Oe&&ht.data===Ae){o=ht,T=!0,Gt(!1);break}var E=w[D],N=i(E,D);y=Wt(ht,f,p,null,E,N,D,r,t,e),f.items.set(N,y),p=y}v>0&&Ft(te())}if($)v===0&&s&&(l=Bt(()=>s(o)));else if(Ve()){var I=new Set,R=Be;for(D=0;D<v;D+=1){E=w[D],N=i(E,D);var H=f.items.get(N)??_.get(N);H?_e(H,E,D):(y=Wt(null,f,null,null,E,N,D,r,t,e,!0),_.set(N,y)),I.add(N)}for(const[U,Y]of f.items)I.has(U)||R.skipped_effects.add(Y.e);R.oncommit(h)}else h();T&&Gt(!0),m(u)}),$&&(o=ht)}function ni(a,t,e,i,r,s,o,f,d){var l=t.length,g=e.items,_=e.first,u=_,w,c=null,h=[],v=[],T,P,p,y;for(y=0;y<l;y+=1){if(T=t[y],P=f(T,y),p=g.get(P),p===void 0){var D=i.get(P);if(D!==void 0){i.delete(P),g.set(P,D);var E=c?c.next:u;Z(e,c,D),Z(e,D,E),At(D,E,r),c=D}else{var N=u?u.e.nodes_start:r;c=Wt(N,e,c,c===null?e.first:c.next,T,P,y,s,o,d)}g.set(P,c),h=[],v=[],u=c.next;continue}if(_e(p,T,y),(p.e.f&Ot)!==0&&ue(p.e),p!==u){if(w!==void 0&&w.has(p)){if(h.length<v.length){var I=v[0],R;c=I.prev;var H=h[0],U=h[h.length-1];for(R=0;R<h.length;R+=1)At(h[R],I,r);for(R=0;R<v.length;R+=1)w.delete(v[R]);Z(e,H.prev,U.next),Z(e,c,H),Z(e,U,I),u=I,c=U,y-=1,h=[],v=[]}else w.delete(p),At(p,u,r),Z(e,p.prev,p.next),Z(e,p,c===null?e.first:c.next),Z(e,c,p),c=p;continue}for(h=[],v=[];u!==null&&u.k!==P;)(u.e.f&Ot)===0&&(w??=new Set).add(u),v.push(u),u=u.next;if(u===null)continue;p=u}h.push(p),c=p,u=p.next}if(u!==null||w!==void 0){for(var Y=w===void 0?[]:ce(w);u!==null;)(u.e.f&Ot)===0&&Y.push(u),u=u.next;var ot=Y.length;if(ot>0){var tt=l===0?r:null;ai(e,Y,tt)}}a.first=e.first&&e.first.e,a.last=c&&c.e;for(var _t of i.values())de(_t.e);i.clear()}function _e(a,t,e,i){We(a.v,t),a.i=e}function Wt(a,t,e,i,r,s,o,f,d,l,g){var _=(d&Ye)!==0,u=(d&Xe)===0,w=_?u?B(r,!1,!1):ee(r):r,c=(d&Ze)===0?o:ee(o),h={i:c,v:w,k:s,a:null,e:null,prev:e,next:i};try{if(a===null){var v=document.createDocumentFragment();v.append(a=le())}return h.e=Bt(()=>f(a,w,c,l),$),h.e.prev=e&&e.e,h.e.next=i&&i.e,e===null?g||(t.first=h):(e.next=h,e.e.next=h.e),i!==null&&(i.prev=h,i.e.prev=h.e),h}finally{}}function At(a,t,e){for(var i=a.next?a.next.e.nodes_start:e,r=t?t.e.nodes_start:e,s=a.e.nodes_start;s!==null&&s!==i;){var o=Ue(s);r.before(s),s=o}}function Z(a,t,e){t===null?a.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Zt(a,t,e=!1){if(a.multiple){if(t==null)return;if(!he(t))return $e();for(var i of a.options)i.selected=t.includes(oe(i));return}for(i of a.options){var r=oe(i);if(ti(r,t)){i.selected=!0;return}}(!e||t!==void 0)&&(a.selectedIndex=-1)}function se(a){var t=new MutationObserver(()=>{Zt(a,a.__value)});t.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),je(()=>{t.disconnect()})}function oe(a){return"__value"in a?a.__value:a.value}const xe={osm:{key:"osm",label:"OpenStreetMap",template:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors"},satellite:{key:"satellite",label:"ArcGIS World Imagery",template:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, Maxar, Earthstar Geographics",maxZoom:19}};function ae(a){return xe[a]}const gt=Object.values(xe);var li=W("<option> </option>"),ci=W('<p class="search-error svelte-oydtmz"> </p>'),hi=W('<p class="search-message svelte-oydtmz"> </p>'),ui=W('<li><button type="button" class="svelte-oydtmz"> </button></li>'),di=W('<ul class="search-results svelte-oydtmz"></ul>'),vi=W("<div><span>Center Lat</span> <strong> </strong></div> <div><span>Center Lng</span> <strong> </strong></div>",1),pi=W("<div><span>North</span> <strong> </strong></div> <div><span>South</span> <strong> </strong></div> <div><span>West</span> <strong> </strong></div> <div><span>East</span> <strong> </strong></div>",1),fi=W('<div class="placeholder">Map loading… pan or zoom on canvas</div>'),mi=W('<section class="panel svelte-oydtmz"><header><div><h1 class="svelte-oydtmz">Tessellate Maps</h1> <p class="svelte-oydtmz">Export map tiles into a printable A4 grid.</p></div> <button class="export svelte-oydtmz"><!></button></header> <div class="grid svelte-oydtmz"><label class="svelte-oydtmz"><span>Rows</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Cols</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Zoom +Δ</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Orientation</span> <select class="svelte-oydtmz"><option>Portrait</option><option>Landscape</option></select></label> <label class="svelte-oydtmz"><span>Provider</span> <select class="svelte-oydtmz"></select></label> <label class="svelte-oydtmz"><span>DPI</span> <input type="number" min="72" step="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>File Prefix</span> <input type="text" class="svelte-oydtmz"/></label></div> <form class="search svelte-oydtmz"><label class="svelte-oydtmz"><span>Jump to location</span> <div class="search-row svelte-oydtmz"><input type="text" placeholder="City, address or lat,lng" class="svelte-oydtmz"/> <button type="submit" class="svelte-oydtmz"> </button></div></label> <!></form> <div class="meta svelte-oydtmz"><div><span>Zoom</span> <strong> </strong></div> <!> <!></div></section>');function gi(a,t){ve(t,!0);const e=k(t,"rows",3,2),i=k(t,"cols",3,2),r=k(t,"zoomDelta",3,1),s=k(t,"orientation",3,"portrait"),o=k(t,"provider",3,"osm"),f=k(t,"zoom",3,15),d=k(t,"viewbox",3,null),l=k(t,"center",3,null),g=k(t,"isExporting",3,!1),_=k(t,"dpi",3,300),u=k(t,"filePrefix",3,"map"),w=me();let c=ut(""),h=ut(ei([])),v=ut(!1),T=ut(""),P=ut("");function p(n,z){const M=Number.parseInt(z,10);if(Number.isNaN(M))return;const C=n==="dpi"?72:n==="zoomDelta"?0:1;w("change",{[n]:Math.max(C,M)})}function y(n){w("change",{orientation:n})}function D(n){w("change",{provider:n})}function E(n){const z=n.trim();w("change",{filePrefix:z||"map"})}function N(){w("export")}function I(n,z,M){w("locate",{lat:n,lng:z,label:M}),L(P,M?`Centered on ${M}`:`Centered on ${n.toFixed(4)}, ${z.toFixed(4)}`,!0)}function R(n){const z=n.split(/[,\s]+/).filter(Boolean);if(z.length<2)return null;const M=Number.parseFloat(z[0]),C=Number.parseFloat(z[1]);return Number.isNaN(M)||Number.isNaN(C)||M<-90||M>90||C<-180||C>180?null:{lat:M,lng:C}}async function H(n){n?.preventDefault();const z=m(c).trim();if(L(T,""),L(h,[],!0),L(P,""),!z)return;const M=R(z);if(M){I(M.lat,M.lng);return}L(v,!0);try{const C=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=${encodeURIComponent(z)}`,{headers:{Accept:"application/json","User-Agent":"tessellate-maps/1.0 (https://github.com/giacomonanni/tessellate-maps)"}});if(!C.ok)throw new Error("Search failed");const V=await C.json();if(!V.length){L(P,"No results found."),L(v,!1);return}L(h,V,!0)}catch(C){console.error(C),L(T,"Unable to reach the geocoding service.")}L(v,!1)}function U(n){const z=Number.parseFloat(n.lat),M=Number.parseFloat(n.lon);Number.isNaN(z)||Number.isNaN(M)||(L(h,[],!0),L(c,n.display_name,!0),I(z,M,n.display_name))}var Y=mi(),ot=b(Y),tt=S(b(ot),2);tt.__click=N;var _t=b(tt);{var we=n=>{var z=jt("Exporting…");F(n,z)},ye=n=>{var z=jt("Export Grid");F(n,z)};it(_t,n=>{g()?n(we):n(ye,!1)})}x(tt),x(ot);var xt=S(ot,2),wt=b(xt),yt=S(b(wt),2);rt(yt),yt.__input=n=>p("rows",n.currentTarget.value),x(wt);var bt=S(wt,2),zt=S(b(bt),2);rt(zt),zt.__input=n=>p("cols",n.currentTarget.value),x(bt);var Mt=S(bt,2),St=S(b(Mt),2);rt(St),St.__input=n=>p("zoomDelta",n.currentTarget.value),x(Mt);var Pt=S(Mt,2),q=S(b(Pt),2);q.__change=n=>y(n.currentTarget.value);var Tt=b(q);Tt.value=Tt.__value="portrait";var Ht=S(Tt);Ht.value=Ht.__value="landscape",x(q);var Yt;se(q),x(Pt);var Dt=S(Pt,2),Q=S(b(Dt),2);Q.__change=n=>D(n.currentTarget.value),re(Q,21,()=>gt,ie,(n,z)=>{var M=li(),C=b(M,!0);x(M);var V={};j(()=>{A(C,m(z).label),V!==(V=m(z).key)&&(M.value=(M.__value=m(z).key)??"")}),F(n,M)}),x(Q);var Xt;se(Q),x(Dt);var Et=S(Dt,2),Lt=S(b(Et),2);rt(Lt),Lt.__input=n=>p("dpi",n.currentTarget.value),x(Et);var Ut=S(Et,2),Ct=S(b(Ut),2);rt(Ct),Ct.__input=n=>E(n.currentTarget.value),x(Ut),x(xt);var dt=S(xt,2),It=b(dt),qt=S(b(It),2),vt=b(qt);rt(vt),vt.__input=n=>L(c,n.currentTarget.value,!0);var Nt=S(vt,2),be=b(Nt,!0);x(Nt),x(qt),x(It);var ze=S(It,2);{var Me=n=>{var z=ci(),M=b(z,!0);x(z),j(()=>A(M,m(T))),F(n,z)},Se=n=>{var z=$t(),M=ft(z);{var C=G=>{var O=hi(),J=b(O,!0);x(O),j(()=>A(J,m(P))),F(G,O)},V=G=>{var O=$t(),J=ft(O);{var K=X=>{var at=di();re(at,21,()=>m(h),ie,(pt,nt)=>{var lt=ui(),ct=b(lt);ct.__click=()=>U(m(nt));var Rt=b(ct,!0);x(ct),x(lt),j(()=>A(Rt,m(nt).display_name)),F(pt,lt)}),x(at),F(X,at)};it(J,X=>{m(h).length&&X(K)},!0)}F(G,O)};it(M,G=>{m(P)?G(C):G(V,!1)},!0)}F(n,z)};it(ze,n=>{m(T)?n(Me):n(Se,!1)})}x(dt);var Qt=S(dt,2),kt=b(Qt),Jt=S(b(kt),2),Pe=b(Jt);x(Jt),x(kt);var Kt=S(kt,2);{var Te=n=>{var z=vi(),M=ft(z),C=S(b(M),2),V=b(C,!0);x(C),x(M);var G=S(M,2),O=S(b(G),2),J=b(O,!0);x(O),x(G),j((K,X)=>{A(V,K),A(J,X)},[()=>l().lat.toFixed(4),()=>l().lng.toFixed(4)]),F(n,z)};it(Kt,n=>{l()&&n(Te)})}var De=S(Kt,2);{var Ee=n=>{var z=pi(),M=ft(z),C=S(b(M),2),V=b(C,!0);x(C),x(M);var G=S(M,2),O=S(b(G),2),J=b(O,!0);x(O),x(G);var K=S(G,2),X=S(b(K),2),at=b(X,!0);x(X),x(K);var pt=S(K,2),nt=S(b(pt),2),lt=b(nt,!0);x(nt),x(pt),j((ct,Rt,Ce,Ie)=>{A(V,ct),A(J,Rt),A(at,Ce),A(lt,Ie)},[()=>d().n.toFixed(4),()=>d().s.toFixed(4),()=>d().w.toFixed(4),()=>d().e.toFixed(4)]),F(n,z)},Le=n=>{var z=fi();F(n,z)};it(De,n=>{d()?n(Ee):n(Le,!1)})}x(Qt),x(Y),j(()=>{tt.disabled=g(),st(yt,e()),st(zt,i()),st(St,r()),Yt!==(Yt=s())&&(q.value=(q.__value=s())??"",Zt(q,s())),Xt!==(Xt=o())&&(Q.value=(Q.__value=o())??"",Zt(Q,o())),st(Lt,_()),st(Ct,u()),st(vt,m(c)),Nt.disabled=m(v),A(be,m(v)?"Searching…":"Go"),A(Pe,`z${f()??""}`)}),oi("submit",dt,H),F(a,Y),pe()}ge(["click","input","change"]);class _i{constructor(t,e){this.p=t,this.provider=ae(e),this.cache=new Map,this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.token=""}getTileSize(){return this.tileSize}setProvider(t){this.provider=ae(t),this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.cache.clear()}setApiToken(t){this.token=t,this.cache.clear()}latLngToPixel(t,e,i){const r=this.tileSize*Math.pow(2,i),s=(t+180)/360*r,o=Math.sin(e*Math.PI/180),f=(.5-Math.log((1+o)/(1-o))/(4*Math.PI))*r;return{x:s,y:f}}pixelToLatLng(t,e,i){const r=this.tileSize*Math.pow(2,i),s=t/r,o=e/r,f=s*360-180,d=Math.PI-2*Math.PI*o,l=180/Math.PI*Math.atan(.5*(Math.exp(d)-Math.exp(-d)));return{lng:f,lat:l}}getTile(t,e,i){const r=Math.pow(2,t),s=(e%r+r)%r,o=Math.max(0,Math.min(r-1,i)),f=`${this.provider.key}/${t}/${s}/${o}`,d=this.cache.get(f);if(d)return d;const l={image:null,ready:!1,failed:!1,waiters:[]};this.cache.set(f,l);const g=this.buildUrl(t,s,o);return this.p.loadImage(g,_=>{l.image=_,l.ready=!0,l.failed=!1,this.resolve(l)},()=>{l.ready=!0,l.failed=!0,this.resolve(l)}),l}resolve(t){t.waiters.length&&(t.waiters.forEach(e=>e()),t.waiters=[])}buildUrl(t,e,i){let r=this.template.replace("{z}",String(t)).replace("{x}",String(e)).replace("{y}",String(i));if(r.includes("{s}")&&this.subdomains.length){const s=Math.abs((e+i)%this.subdomains.length);r=r.replace("{s}",this.subdomains[s])}return r.includes("{token}")&&(r=r.replace("{token}",encodeURIComponent(this.token))),r}}function xi(a){return a.ready?Promise.resolve():new Promise(t=>{a.waiters.push(t)})}const ne=25.4;function wi(a,t){const e=a==="portrait"?210:297,i=a==="portrait"?297:210;return{widthPx:Math.round(e/ne*t),heightPx:Math.round(i/ne*t)}}function yi(a){return a==="portrait"?210/297:297/210}async function bi(a,t,e,i){const r=t.getTileSize(),s=t.latLngToPixel(e.w,e.n,i),o=t.latLngToPixel(e.e,e.s,i),f=Math.floor(s.x/r),d=Math.floor(o.x/r),l=Math.floor(s.y/r),g=Math.floor(o.y/r),_=s.x,u=s.y,w=Math.max(1,Math.ceil(o.x-s.x)),c=Math.max(1,Math.ceil(o.y-s.y)),h=a.createGraphics(w,c);for(let v=l;v<=g;v+=1)for(let T=f;T<=d;T+=1){const P=t.getTile(i,T,v);if(await xi(P),P.ready&&P.image){const p=T*r-_,y=v*r-u;h.image(P.image,p,y,r,r)}}return h}async function zi(a,t,e,i){const{rows:r,cols:s,zoom:o,zoomDelta:f,orientation:d,dpi:l,filePrefix:g="map"}=i,_=Math.min(19,o+f),{widthPx:u,heightPx:w}=wi(d,l);for(let c=0;c<r;c+=1)for(let h=0;h<s;h+=1){const v=c*s+h,T=e[v],P=await bi(a,t,{n:T.n,s:T.s,w:T.w,e:T.e},_),p=a.createGraphics(u,w);p.image(P,0,0,u,w);const y=`${g}_${String(c+1).padStart(2,"0")}_${String(h+1).padStart(2,"0")}_${d}_z${_}.png`;a.save(p,y),await Mi(140)}}function Mi(a){return new Promise(t=>setTimeout(t,a))}function Vt(a,t,e,i){const r=a.latLngToPixel(t.lng,t.lat,e),s=r.x-i.width/2,o=r.y-i.height/2,f=s+i.width,d=o+i.height,l=a.pixelToLatLng(s,o,e),g=a.pixelToLatLng(f,d,e);return{zoom:e,pixelBounds:{left:s,top:o,width:i.width,height:i.height},latLngBounds:{n:l.lat,s:g.lat,w:l.lng,e:g.lng},centerPixel:r}}function Si(a,t,e,i){const{zoom:r,pixelBounds:s}=t,o=s.width/i,f=s.height/e,d=[];for(let l=0;l<e;l+=1)for(let g=0;g<i;g+=1){const _=s.left+g*o,u=s.top+l*f,w=_+o,c=u+f,h=a.pixelToLatLng(_,u,r),v=a.pixelToLatLng(w,c,r);d.push({n:h.lat,s:v.lat,w:h.lng,e:v.lng,row:l,col:g})}return d}class Pi{constructor(t,e={}){this.target=t,this.options={rows:e.rows??2,cols:e.cols??3,zoom:e.zoom??15,zoomDelta:e.zoomDelta??0,orientation:e.orientation??"portrait",provider:e.provider??"osm",dpi:e.dpi??300,filePrefix:e.filePrefix??"map"},this.rows=this.options.rows,this.cols=this.options.cols,this.zoom=this.options.zoom,this.zoomDelta=this.options.zoomDelta,this.orientation=this.options.orientation,this.provider=this.options.provider,this.dpi=this.options.dpi,this.filePrefix=this.options.filePrefix??"map",this.p=null,this.p5Constructor=null,this.tileSystem=null,this.viewbox=null,this.center={lat:52.52,lng:13.405},this.stateSubscribers=new Set,this.shortcutListeners=new Set,this.viewport=null}async init(){if(!this.p){if(!this.p5Constructor){const t=await ii(()=>import("../chunks/DLNX37f0.js"),[],import.meta.url);this.p5Constructor=t.default}await new Promise(t=>{if(!this.p5Constructor)return t();this.p=new this.p5Constructor(e=>this.defineSketch(e,t),this.target)})}}defineSketch(t,e){t.setup=()=>{const i=this.target.getBoundingClientRect();t.createCanvas(Math.max(1,i.width),Math.max(1,i.height)),t.pixelDensity(1),this.tileSystem=new _i(t,this.provider),this.notifyState(),e()},t.windowResized=()=>{this.resize()},t.draw=()=>{this.render(t)},t.mouseDragged=()=>{this.handleDrag(t)},t.touchMoved=()=>(this.handleDrag(t),!1),t.keyPressed=()=>{t.key==="+"||t.key==="="?this.setZoom(this.zoom+1,t.width/2,t.height/2):(t.key==="-"||t.key==="_")&&this.setZoom(this.zoom-1,t.width/2,t.height/2)}}render(t){if(!this.tileSystem)return;t.background("azure");const e=this.computeGridFrame(t.width,t.height),i=Vt(this.tileSystem,this.center,this.zoom,e);this.applyViewport(i);const r=this.tileSystem.getTileSize(),{left:s,top:o,width:f,height:d}=i.pixelBounds,l=Math.floor(s/r),g=Math.floor((s+f)/r),_=Math.floor(o/r),u=Math.floor((o+d)/r),w=t.drawingContext;w.save(),w.beginPath(),w.rect(e.left,e.top,e.width,e.height),w.clip();for(let c=_;c<=u;c+=1)for(let h=l;h<=g;h+=1){const v=this.tileSystem.getTile(this.zoom,h,c);if(v.ready&&v.image){const T=h*r-s+e.left,P=c*r-o+e.top;t.image(v.image,T,P,r,r)}}w.restore(),this.drawGrid(t,e)}drawGrid(t,e){t.stroke("blue"),t.noFill(),t.rect(e.left,e.top,e.width,e.height);const i=e.width/this.cols,r=e.height/this.rows;for(let s=0;s<=this.rows;s+=1){const o=e.top+s*r;t.line(e.left,o,e.left+e.width,o)}for(let s=0;s<=this.cols;s+=1){const o=e.left+s*i;t.line(o,e.top,o,e.top+e.height)}}handleDrag(t){if(!this.tileSystem||Array.isArray(t.touches)&&t.touches.length>1)return;const e=this.screenToWorld(t.mouseX,t.mouseY),i=this.screenToWorld(t.pmouseX,t.pmouseY);this.center.lat+=i.lat-e.lat,this.center.lng+=i.lng-e.lng,this.center.lat=this.clampLatitude(this.center.lat),this.center.lng=this.normalizeLongitude(this.center.lng),this.invalidateViewport()}setZoom(t,e,i){if(!this.tileSystem||!this.p)return;const r=Math.max(1,Math.min(19,t));if(r===this.zoom)return;const s=this.screenToWorld(e,i);this.zoom=r;const o=this.screenToWorld(e,i);this.center.lat+=s.lat-o.lat,this.center.lng+=s.lng-o.lng,this.invalidateViewport(),this.notifyState()}zoomBy(t){if(!this.p)return;const e=this.p.width/2,i=this.p.height/2;this.setZoom(this.zoom+t,e,i)}screenToWorld(t,e){if(!this.tileSystem||!this.p)return this.center;const i=this.computeGridFrame(this.p.width,this.p.height),r=this.tileSystem.latLngToPixel(this.center.lng,this.center.lat,this.zoom),s=t-i.left,o=e-i.top,f=r.x-i.width/2+s,d=r.y-i.height/2+o;return this.tileSystem.pixelToLatLng(f,d,this.zoom)}cycleProvider(){const t=gt.findIndex(i=>i.key===this.provider),e=gt[(t+1)%gt.length];this.setProvider(e.key)}resize(t,e){if(!this.p)return;const i=this.target.getBoundingClientRect(),r=Math.max(1,t??i.width),s=Math.max(1,e??i.height);this.p.resizeCanvas(r,s),this.invalidateViewport()}applyViewport(t){this.viewport=t,this.viewbox={...t.latLngBounds},this.notifyState()}invalidateViewport(){this.viewport=null,this.viewbox=null}updateViewbox(t){if(!this.tileSystem||!this.p)return;let e=t;if(!e){const i=this.computeGridFrame(this.p.width,this.p.height);e=Vt(this.tileSystem,this.center,this.zoom,i)}this.applyViewport(e)}async exportGrid(){if(!this.tileSystem||!this.p)return;let t=this.viewport;if(!t){const i=this.computeGridFrame(this.p.width,this.p.height);t=Vt(this.tileSystem,this.center,this.zoom,i),this.applyViewport(t)}const e=Si(this.tileSystem,t,this.rows,this.cols);await zi(this.p,this.tileSystem,e,{rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,orientation:this.orientation,dpi:this.dpi,filePrefix:this.filePrefix})}setCenter(t,e,i){const r=this.clampLatitude(t),s=this.normalizeLongitude(e);this.center.lat=r,this.center.lng=s,typeof i=="number"&&(this.zoom=Math.max(1,Math.min(19,Math.round(i)))),this.invalidateViewport(),this.notifyState()}subscribe(t){return this.stateSubscribers.add(t),t(this.snapshot()),()=>{this.stateSubscribers.delete(t)}}onExportShortcut(t){return this.shortcutListeners.add(t),()=>{this.shortcutListeners.delete(t)}}triggerExportShortcut(){this.shortcutListeners.forEach(t=>t())}snapshot(){return{center:{...this.center},rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,provider:this.provider,orientation:this.orientation,viewbox:this.viewbox?{...this.viewbox}:null}}notifyState(){const t=this.snapshot();this.stateSubscribers.forEach(e=>e(t))}setGrid(t,e){const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(e));i===this.rows&&r===this.cols||(this.rows=i,this.cols=r,this.invalidateViewport(),this.notifyState())}setZoomDelta(t){const e=Math.max(0,Math.round(t));e!==this.zoomDelta&&(this.zoomDelta=e,this.notifyState())}setOrientation(t){t!==this.orientation&&(this.orientation=t,this.invalidateViewport(),this.notifyState())}setProvider(t){t!==this.provider&&(this.provider=t,this.tileSystem&&this.tileSystem.setProvider(t),this.invalidateViewport(),this.notifyState())}setDpi(t){t!==this.dpi&&(this.dpi=t)}setFilePrefix(t){this.filePrefix=t}destroy(){this.p&&this.p.remove(),this.p=null,this.tileSystem=null,this.stateSubscribers.clear(),this.shortcutListeners.clear()}getCellRatio(){return yi(this.orientation)}computeGridFrame(t,e){const i=this.getCellRatio(),r=this.cols*i/Math.max(1,this.rows);let s=t,o=s/r;o>e&&(o=e,s=o*r);const f=(t-s)/2,d=(e-o)/2;return{left:f,top:d,width:s,height:o}}clampLatitude(t){return Math.max(-85,Math.min(85,t))}normalizeLongitude(t){let e=t%360;return e>180&&(e-=360),e<-180&&(e+=360),e}}var Ti=W('<div class="map-canvas svelte-4tz69q"><div class="zoom-controls svelte-4tz69q" aria-label="Map zoom controls"><button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom in">+</button> <button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom out">-</button></div></div>');function Di(a,t){ve(t,!0);const e=k(t,"rows",3,2),i=k(t,"cols",3,3),r=k(t,"zoomDelta",3,0),s=k(t,"orientation",3,"portrait"),o=k(t,"provider",3,"osm"),f=k(t,"dpi",3,300),d=k(t,"filePrefix",3,"map"),l=me();let g=null,_=null,u=null;ri(()=>{if(!g)return;const E=new Pi(g,{rows:e(),cols:i(),zoomDelta:r(),orientation:s(),provider:o(),dpi:f(),filePrefix:d()}),N=[];return E.init().then(()=>l("ready",E)),N.push(E.subscribe(I=>l("state",I))),N.push(E.onExportShortcut(()=>l("exportshortcut"))),u=new ResizeObserver(I=>{if(!I.length)return;const{width:R,height:H}=I[0].contentRect;E.resize(R,H)}),u.observe(g),_=E,()=>{N.forEach(I=>I()),u?.disconnect(),E.destroy(),_=null}}),si(()=>{u?.disconnect()}),et(()=>{_&&_.setGrid(e(),i())}),et(()=>{_&&_.setZoomDelta(r())}),et(()=>{_&&_.setOrientation(s())}),et(()=>{_&&_.setProvider(o())}),et(()=>{_&&_.setDpi(f())}),et(()=>{_&&_.setFilePrefix(d())});function w(){_?.zoomBy(1)}function c(){_?.zoomBy(-1)}async function h(){_&&await _.exportGrid()}function v(E,N,I){_?.setCenter(E,N,I)}var T={exportGrid:h,focusOn:v},P=Ti(),p=b(P),y=b(p);y.__click=w;var D=S(y,2);return D.__click=c,x(p),x(P),fe(P,E=>g=E,()=>g),F(a,P),pe(T)}ge(["click"]);var Ei=W('<main class="page svelte-1uha8ag"><section class="panel svelte-1uha8ag"><!></section> <section class="canvas svelte-1uha8ag"><!></section></main>');function Gi(a){let t=B(2),e=B(2),i=B(0),r=B("portrait"),s=B("osm"),o=B(300),f=B("map"),d=B(!1),l=B(null),g=B(null);function _(p){const y=p.detail;typeof y.rows=="number"&&L(t,y.rows),typeof y.cols=="number"&&L(e,y.cols),typeof y.zoomDelta=="number"&&L(i,y.zoomDelta),y.orientation&&L(r,y.orientation),y.provider&&L(s,y.provider),typeof y.dpi=="number"&&L(o,y.dpi),y.filePrefix&&L(f,y.filePrefix)}async function u(){if(!(!m(l)||m(d))){L(d,!0);try{await m(l).exportGrid()}catch(p){console.error(p)}L(d,!1)}}function w(p){if(!m(l))return;const{lat:y,lng:D,zoom:E}=p.detail;m(l).focusOn(y,D,E)}var c=Ei(),h=b(c),v=b(h);{let p=mt(()=>m(g)?.zoom??15),y=mt(()=>m(g)?.viewbox??null),D=mt(()=>m(g)?.center??null);gi(v,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get zoom(){return m(p)},get viewbox(){return m(y)},get center(){return m(D)},get isExporting(){return m(d)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{change:_,export:u,locate:w}})}x(h);var T=S(h,2),P=b(T);fe(Di(P,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{state:p=>L(g,p.detail),exportshortcut:u},$$legacy:!0}),p=>L(l,p),()=>m(l)),x(T),x(c),F(a,c)}export{Gi as component};
