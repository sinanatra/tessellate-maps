import{f as B,a as A,t as te,c as ee}from"../chunks/BX9JqRfx.js";import"../chunks/C_mhSzNy.js";import{a as he,Q as Ae,P as Ot,h as it,G as Re,M as Oe,w as _,a1 as gt,S as Fe,U as We,V as ie,W as Ft,e as ut,ae as Ve,aD as Be,b as Ht,s as He,c as Ye,al as Xe,aG as W,ac as re,aB as ue,k as de,aL as Ze,r as ve,p as Ue,aM as qe,aN as Qe,aO as Wt,d as fe,ax as Je,aP as Ke,aA as je,aQ as $e,I as ti,as as ei,aR as ii,aS as ri,z as pe,aH as dt,a2 as si,F as S,D as y,a3 as L,B as j,C as me,E as x,A as mt,u as $}from"../chunks/DaC0ZXKz.js";import{p as k,i as st,_ as oi,b as ge}from"../chunks/B19H37eM.js";import{c as _e,o as ni,a as ai}from"../chunks/Cv0Hl5ep.js";import{d as xe,e as li,s as F}from"../chunks/BALP7dZq.js";import{r as tt,a as et}from"../chunks/BHoUpGYX.js";function se(s,t){return t}function ci(s,t,e){for(var i=s.items,r=[],o=t.length,n=0;n<o;n++)Ke(t[n].e,r,!0);var c=o>0&&r.length===0&&e!==null;if(c){var h=e.parentNode;je(h),h.append(e),i.clear(),H(s,t[0].prev,t[o-1].next)}$e(r,()=>{for(var u=0;u<o;u++){var f=t[u];c||(i.delete(f.k),H(s,f.prev,f.next)),fe(f.e,!c)}})}function oe(s,t,e,i,r,o=null){var n=s,c={flags:t,items:new Map,first:null};{var h=s;n=it?Ot(Re(h)):h.appendChild(he())}it&&Oe();var u=null,f=!1,z=new Map,a=gt(()=>{var d=e();return de(d)?d:d==null?[]:ue(d)}),m,p;function v(){hi(p,m,c,z,n,r,t,i,e),o!==null&&(m.length===0?u?ve(u):u=Ht(()=>o(n)):u!==null&&Ue(u,()=>{u=null}))}Ae(()=>{p??=ti,m=_(a);var d=m.length;if(f&&d===0)return;f=d===0;let G=!1;if(it){var T=Fe(n)===We;T!==(d===0)&&(n=ie(),Ot(n),Ft(!1),G=!0)}if(it){for(var M=null,b,g=0;g<d;g++){if(ut.nodeType===Ve&&ut.data===Be){n=ut,G=!0,Ft(!1);break}var I=m[g],E=i(I,g);b=Yt(ut,c,M,null,I,E,g,r,t,e),c.items.set(E,b),M=b}d>0&&Ot(ie())}if(it)d===0&&o&&(u=Ht(()=>o(n)));else if(He()){var N=new Set,C=Ye;for(g=0;g<d;g+=1){I=m[g],E=i(I,g);var Y=c.items.get(E)??z.get(E);Y?be(Y,I,g):(b=Yt(null,c,null,null,I,E,g,r,t,e,!0),z.set(E,b)),N.add(E)}for(const[X,U]of c.items)N.has(X)||C.skipped_effects.add(U.e);C.oncommit(v)}else v();G&&Ft(!0),_(a)}),it&&(n=ut)}function hi(s,t,e,i,r,o,n,c,h){var u=t.length,f=e.items,z=e.first,a=z,m,p=null,v=[],d=[],G,T,M,b;for(b=0;b<u;b+=1){if(G=t[b],T=c(G,b),M=f.get(T),M===void 0){var g=i.get(T);if(g!==void 0){i.delete(T),f.set(T,g);var I=p?p.next:a;H(e,p,g),H(e,g,I),Vt(g,I,r),p=g}else{var E=a?a.e.nodes_start:r;p=Yt(E,e,p,p===null?e.first:p.next,G,T,b,o,n,h)}f.set(T,p),v=[],d=[],a=p.next;continue}if(be(M,G,b),(M.e.f&Wt)!==0&&ve(M.e),M!==a){if(m!==void 0&&m.has(M)){if(v.length<d.length){var N=d[0],C;p=N.prev;var Y=v[0],X=v[v.length-1];for(C=0;C<v.length;C+=1)Vt(v[C],N,r);for(C=0;C<d.length;C+=1)m.delete(d[C]);H(e,Y.prev,X.next),H(e,p,Y),H(e,X,N),a=N,p=X,b-=1,v=[],d=[]}else m.delete(M),Vt(M,a,r),H(e,M.prev,M.next),H(e,M,p===null?e.first:p.next),H(e,p,M),p=M;continue}for(v=[],d=[];a!==null&&a.k!==T;)(a.e.f&Wt)===0&&(m??=new Set).add(a),d.push(a),a=a.next;if(a===null)continue;M=a}v.push(M),p=M,a=M.next}if(a!==null||m!==void 0){for(var U=m===void 0?[]:ue(m);a!==null;)(a.e.f&Wt)===0&&U.push(a),a=a.next;var ot=U.length;if(ot>0){var nt=u===0?r:null;ci(e,U,nt)}}s.first=e.first&&e.first.e,s.last=p&&p.e;for(var rt of i.values())fe(rt.e);i.clear()}function be(s,t,e,i){Xe(s.v,t),s.i=e}function Yt(s,t,e,i,r,o,n,c,h,u,f){var z=(h&qe)!==0,a=(h&Qe)===0,m=z?a?W(r,!1,!1):re(r):r,p=(h&Ze)===0?n:re(n),v={i:p,v:m,k:o,a:null,e:null,prev:e,next:i};try{if(s===null){var d=document.createDocumentFragment();d.append(s=he())}return v.e=Ht(()=>c(s,m,p,u),it),v.e.prev=e&&e.e,v.e.next=i&&i.e,e===null?f||(t.first=v):(e.next=v,e.e.next=v.e),i!==null&&(i.prev=v,i.e.prev=v.e),v}finally{}}function Vt(s,t,e){for(var i=s.next?s.next.e.nodes_start:e,r=t?t.e.nodes_start:e,o=s.e.nodes_start;o!==null&&o!==i;){var n=Je(o);r.before(o),o=n}}function H(s,t,e){t===null?s.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Xt(s,t,e=!1){if(s.multiple){if(t==null)return;if(!de(t))return ii();for(var i of s.options)i.selected=t.includes(ae(i));return}for(i of s.options){var r=ae(i);if(ri(r,t)){i.selected=!0;return}}(!e||t!==void 0)&&(s.selectedIndex=-1)}function ne(s){var t=new MutationObserver(()=>{Xt(s,s.__value)});t.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),ei(()=>{t.disconnect()})}function ae(s){return"__value"in s?s.__value:s.value}const ye={osm:{key:"osm",label:"OpenStreetMap",template:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors"},satellite:{key:"satellite",label:"ArcGIS World Imagery",template:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, Maxar, Earthstar Geographics",maxZoom:19},cartoLight:{key:"cartoLight",label:"CARTO Positron",template:"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",subdomains:["a","b","c","d"],attribution:"© OpenStreetMap contributors, © CARTO"},osmHot:{key:"osmHot",label:"OSM Humanitarian",template:"https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors, Humanitarian style"},esriTopo:{key:"esriTopo",label:"Esri World Topographic",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"},esriGray:{key:"esriGray",label:"Esri Light Gray",template:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri | Esri Light Gray Canvas"},esriStreets:{key:"esriStreets",label:"Esri World Street Map",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"}};function le(s){return ye[s]}const _t=Object.values(ye).filter(s=>!s.requiresToken||!!s.token);var ui=B("<option> </option>"),di=B('<p class="search-error svelte-oydtmz"> </p>'),vi=B('<p class="search-message svelte-oydtmz"> </p>'),fi=B('<li><button type="button" class="svelte-oydtmz"> </button></li>'),pi=B('<ul class="search-results svelte-oydtmz"></ul>'),mi=B("<div><span>Center Lat</span> <strong> </strong></div> <div><span>Center Lng</span> <strong> </strong></div>",1),gi=B("<div><span>North</span> <strong> </strong></div> <div><span>South</span> <strong> </strong></div> <div><span>West</span> <strong> </strong></div> <div><span>East</span> <strong> </strong></div>",1),_i=B('<div class="placeholder">Map loading… pan or zoom on canvas</div>'),xi=B('<section class="panel svelte-oydtmz"><header><div><h1 class="svelte-oydtmz">Export map tiles into <br/> a printable A4 grid</h1></div> <button class="export svelte-oydtmz"><!></button></header> <div class="grid svelte-oydtmz"><label class="svelte-oydtmz"><span>Rows</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Cols</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Zoom +Δ</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Inner grid</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Orientation</span> <select class="svelte-oydtmz"><option>Portrait</option><option>Landscape</option></select></label> <label class="svelte-oydtmz"><span>Provider</span> <select class="svelte-oydtmz"></select></label> <label class="svelte-oydtmz"><span>DPI</span> <input type="number" min="72" step="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>File Prefix</span> <input type="text" class="svelte-oydtmz"/></label></div> <form class="search svelte-oydtmz"><label class="svelte-oydtmz"><span>Jump to location</span> <div class="search-row svelte-oydtmz"><input type="text" placeholder="City, address or lat,lng" class="svelte-oydtmz"/> <button type="submit" class="svelte-oydtmz"> </button></div></label> <!></form> <div class="meta svelte-oydtmz"><div><span>Zoom</span> <strong> </strong></div> <!> <!></div></section>');function bi(s,t){pe(t,!0);const e=k(t,"rows",3,2),i=k(t,"cols",3,2),r=k(t,"zoomDelta",3,1),o=k(t,"orientation",3,"portrait"),n=k(t,"provider",3,"osm"),c=k(t,"zoom",3,15),h=k(t,"viewbox",3,null),u=k(t,"center",3,null),f=k(t,"isExporting",3,!1),z=k(t,"dpi",3,300),a=k(t,"filePrefix",3,"map"),m=k(t,"innerGrid",3,0),p=_e();let v=dt(""),d=dt(si([])),G=dt(!1),T=dt(""),M=dt("");function b(l,w){const P=Number.parseInt(w,10);if(Number.isNaN(P))return;const D=l==="dpi"?72:l==="zoomDelta"||l==="innerGrid"?0:1;p("change",{[l]:Math.max(D,P)})}function g(l){p("change",{orientation:l})}function I(l){p("change",{provider:l})}function E(l){const w=l.trim();p("change",{filePrefix:w||"map"})}function N(){p("export")}function C(l,w,P){p("locate",{lat:l,lng:w,label:P}),L(M,P?`Centered on ${P}`:`Centered on ${l.toFixed(4)}, ${w.toFixed(4)}`,!0)}function Y(l){const w=l.split(/[,\s]+/).filter(Boolean);if(w.length<2)return null;const P=Number.parseFloat(w[0]),D=Number.parseFloat(w[1]);return Number.isNaN(P)||Number.isNaN(D)||P<-90||P>90||D<-180||D>180?null:{lat:P,lng:D}}async function X(l){l?.preventDefault();const w=_(v).trim();if(L(T,""),L(d,[],!0),L(M,""),!w)return;const P=Y(w);if(P){C(P.lat,P.lng);return}L(G,!0);try{const D=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=${encodeURIComponent(w)}`,{headers:{Accept:"application/json","User-Agent":"tessellate-maps/1.0 (https://github.com/giacomonanni/tessellate-maps)"}});if(!D.ok)throw new Error("Search failed");const V=await D.json();if(!V.length){L(M,"No results found."),L(G,!1);return}L(d,V,!0)}catch(D){console.error(D),L(T,"Unable to reach the geocoding service.")}L(G,!1)}function U(l){const w=Number.parseFloat(l.lat),P=Number.parseFloat(l.lon);Number.isNaN(w)||Number.isNaN(P)||(L(d,[],!0),L(v,l.display_name,!0),C(w,P,l.display_name))}var ot=xi(),nt=y(ot),rt=S(y(nt),2);rt.__click=N;var we=y(rt);{var ze=l=>{var w=te("Exporting…");A(l,w)},Me=l=>{var w=te("Export Grid");A(l,w)};st(we,l=>{f()?l(ze):l(Me,!1)})}x(rt),x(nt);var xt=S(nt,2),bt=y(xt),yt=S(y(bt),2);tt(yt),yt.__input=l=>b("rows",l.currentTarget.value),x(bt);var wt=S(bt,2),zt=S(y(wt),2);tt(zt),zt.__input=l=>b("cols",l.currentTarget.value),x(wt);var Mt=S(wt,2),St=S(y(Mt),2);tt(St),St.__input=l=>b("zoomDelta",l.currentTarget.value),x(Mt);var Pt=S(Mt,2),Tt=S(y(Pt),2);tt(Tt),Tt.__input=l=>b("innerGrid",l.currentTarget.value),x(Pt);var Gt=S(Pt,2),q=S(y(Gt),2);q.__change=l=>g(l.currentTarget.value);var Et=y(q);Et.value=Et.__value="portrait";var Zt=S(Et);Zt.value=Zt.__value="landscape",x(q);var Ut;ne(q),x(Gt);var Lt=S(Gt,2),Q=S(y(Lt),2);Q.__change=l=>I(l.currentTarget.value),oe(Q,21,()=>_t,se,(l,w)=>{var P=ui(),D=y(P,!0);x(P);var V={};j(()=>{F(D,_(w).label),V!==(V=_(w).key)&&(P.value=(P.__value=_(w).key)??"")}),A(l,P)}),x(Q);var qt;ne(Q),x(Lt);var Ct=S(Lt,2),Dt=S(y(Ct),2);tt(Dt),Dt.__input=l=>b("dpi",l.currentTarget.value),x(Ct);var Qt=S(Ct,2),kt=S(y(Qt),2);tt(kt),kt.__input=l=>E(l.currentTarget.value),x(Qt),x(xt);var vt=S(xt,2),It=y(vt),Jt=S(y(It),2),ft=y(Jt);tt(ft),ft.__input=l=>L(v,l.currentTarget.value,!0);var Nt=S(ft,2),Se=y(Nt,!0);x(Nt),x(Jt),x(It);var Pe=S(It,2);{var Te=l=>{var w=di(),P=y(w,!0);x(w),j(()=>F(P,_(T))),A(l,w)},Ge=l=>{var w=ee(),P=mt(w);{var D=R=>{var O=vi(),J=y(O,!0);x(O),j(()=>F(J,_(M))),A(R,O)},V=R=>{var O=ee(),J=mt(O);{var K=Z=>{var at=pi();oe(at,21,()=>_(d),se,(pt,lt)=>{var ct=fi(),ht=y(ct);ht.__click=()=>U(_(lt));var Rt=y(ht,!0);x(ht),x(ct),j(()=>F(Rt,_(lt).display_name)),A(pt,ct)}),x(at),A(Z,at)};st(J,Z=>{_(d).length&&Z(K)},!0)}A(R,O)};st(P,R=>{_(M)?R(D):R(V,!1)},!0)}A(l,w)};st(Pe,l=>{_(T)?l(Te):l(Ge,!1)})}x(vt);var Kt=S(vt,2),At=y(Kt),jt=S(y(At),2),Ee=y(jt);x(jt),x(At);var $t=S(At,2);{var Le=l=>{var w=mi(),P=mt(w),D=S(y(P),2),V=y(D,!0);x(D),x(P);var R=S(P,2),O=S(y(R),2),J=y(O,!0);x(O),x(R),j((K,Z)=>{F(V,K),F(J,Z)},[()=>u().lat.toFixed(4),()=>u().lng.toFixed(4)]),A(l,w)};st($t,l=>{u()&&l(Le)})}var Ce=S($t,2);{var De=l=>{var w=gi(),P=mt(w),D=S(y(P),2),V=y(D,!0);x(D),x(P);var R=S(P,2),O=S(y(R),2),J=y(O,!0);x(O),x(R);var K=S(R,2),Z=S(y(K),2),at=y(Z,!0);x(Z),x(K);var pt=S(K,2),lt=S(y(pt),2),ct=y(lt,!0);x(lt),x(pt),j((ht,Rt,Ie,Ne)=>{F(V,ht),F(J,Rt),F(at,Ie),F(ct,Ne)},[()=>h().n.toFixed(4),()=>h().s.toFixed(4),()=>h().w.toFixed(4),()=>h().e.toFixed(4)]),A(l,w)},ke=l=>{var w=_i();A(l,w)};st(Ce,l=>{h()?l(De):l(ke,!1)})}x(Kt),x(ot),j(()=>{rt.disabled=f(),et(yt,e()),et(zt,i()),et(St,r()),et(Tt,m()),Ut!==(Ut=o())&&(q.value=(q.__value=o())??"",Xt(q,o())),qt!==(qt=n())&&(Q.value=(Q.__value=n())??"",Xt(Q,n())),et(Dt,z()),et(kt,a()),et(ft,_(v)),Nt.disabled=_(G),F(Se,_(G)?"Searching…":"Go"),F(Ee,`z${c()??""}`)}),li("submit",vt,X),A(s,ot),me()}xe(["click","input","change"]);class yi{constructor(t,e){this.p=t,this.provider=le(e),this.cache=new Map,this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.token=""}getTileSize(){return this.tileSize}setProvider(t){this.provider=le(t),this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.cache.clear()}setApiToken(t){this.token=t,this.cache.clear()}latLngToPixel(t,e,i){const r=this.tileSize*Math.pow(2,i),o=(t+180)/360*r,n=Math.sin(e*Math.PI/180),c=(.5-Math.log((1+n)/(1-n))/(4*Math.PI))*r;return{x:o,y:c}}pixelToLatLng(t,e,i){const r=this.tileSize*Math.pow(2,i),o=t/r,n=e/r,c=o*360-180,h=Math.PI-2*Math.PI*n,u=180/Math.PI*Math.atan(.5*(Math.exp(h)-Math.exp(-h)));return{lng:c,lat:u}}getTile(t,e,i){const r=Math.pow(2,t),o=(e%r+r)%r,n=Math.max(0,Math.min(r-1,i)),c=`${this.provider.key}/${t}/${o}/${n}`,h=this.cache.get(c);if(h)return h;const u={image:null,ready:!1,failed:!1,waiters:[]};this.cache.set(c,u);const f=this.buildUrl(t,o,n);return this.p.loadImage(f,z=>{u.image=z,u.ready=!0,u.failed=!1,this.resolve(u)},()=>{u.ready=!0,u.failed=!0,this.resolve(u)}),u}resolve(t){t.waiters.length&&(t.waiters.forEach(e=>e()),t.waiters=[])}buildUrl(t,e,i){let r=this.template.replace("{z}",String(t)).replace("{x}",String(e)).replace("{y}",String(i));if(r.includes("{s}")&&this.subdomains.length){const o=Math.abs((e+i)%this.subdomains.length);r=r.replace("{s}",this.subdomains[o])}return r.includes("{token}")&&(r=r.replace("{token}",encodeURIComponent(this.token))),r}}function wi(s){return s.ready?Promise.resolve():new Promise(t=>{s.waiters.push(t)})}const ce=25.4;function zi(s,t){const e=s==="portrait"?210:297,i=s==="portrait"?297:210;return{widthPx:Math.round(e/ce*t),heightPx:Math.round(i/ce*t)}}function Mi(s){return s==="portrait"?210/297:297/210}async function Si(s,t,e,i){const r=t.getTileSize(),o=t.latLngToPixel(e.w,e.n,i),n=t.latLngToPixel(e.e,e.s,i),c=Math.floor(o.x/r),h=Math.floor(n.x/r),u=Math.floor(o.y/r),f=Math.floor(n.y/r),z=o.x,a=o.y,m=Math.max(1,Math.ceil(n.x-o.x)),p=Math.max(1,Math.ceil(n.y-o.y)),v=s.createGraphics(m,p);for(let d=u;d<=f;d+=1)for(let G=c;G<=h;G+=1){const T=t.getTile(i,G,d);if(await wi(T),T.ready&&T.image){const M=G*r-z,b=d*r-a;v.image(T.image,M,b,r,r)}}return v}async function Pi(s,t,e,i){const{rows:r,cols:o,zoom:n,zoomDelta:c,orientation:h,dpi:u,filePrefix:f="map",innerGrid:z=0}=i,a=Math.min(19,n+c),{widthPx:m,heightPx:p}=zi(h,u);for(let v=0;v<r;v+=1)for(let d=0;d<o;d+=1){const G=v*o+d,T=e[G],M=await Si(s,t,{n:T.n,s:T.s,w:T.w,e:T.e},a),b=s.createGraphics(m,p);b.image(M,0,0,m,p),Li(b,z),Ei(b,Gi(d),v+1);const g=`${f}_${String(v+1).padStart(2,"0")}_${String(d+1).padStart(2,"0")}_${h}_z${a}.png`;s.save(b,g),await Ti(140)}}function Ti(s){return new Promise(t=>setTimeout(t,s))}function Gi(s){let t=Math.max(0,Math.floor(s)),e="";for(;t>=0;)e=String.fromCharCode(t%26+65)+e,t=Math.floor(t/26)-1;return e}function Ei(s,t,e){const i=`${t}${e}`,r=Math.max(14,Math.round(Math.min(s.width,s.height)*.02)),o=Math.round(r*.4),n=o,c=o+Math.round(r*.5);s.push(),s.textSize(r),s.textAlign(s.LEFT,s.TOP),s.textWidth(i),s.fill("#111"),s.text(i,n,c),s.pop()}function Li(s,t){const e=Math.max(0,Math.round(t));if(e<2)return;const i=s.width/e,r=s.height/e;s.push(),s.stroke(0,0,0,80),s.strokeWeight(1);for(let o=1;o<e;o+=1){const n=o*i;s.line(n,0,n,s.height)}for(let o=1;o<e;o+=1){const n=o*r;s.line(0,n,s.width,n)}s.pop()}function Bt(s,t,e,i){const r=s.latLngToPixel(t.lng,t.lat,e),o=r.x-i.width/2,n=r.y-i.height/2,c=o+i.width,h=n+i.height,u=s.pixelToLatLng(o,n,e),f=s.pixelToLatLng(c,h,e);return{zoom:e,pixelBounds:{left:o,top:n,width:i.width,height:i.height},latLngBounds:{n:u.lat,s:f.lat,w:u.lng,e:f.lng},centerPixel:r}}function Ci(s,t,e,i){const{zoom:r,pixelBounds:o}=t,n=o.width/i,c=o.height/e,h=[];for(let u=0;u<e;u+=1)for(let f=0;f<i;f+=1){const z=o.left+f*n,a=o.top+u*c,m=z+n,p=a+c,v=s.pixelToLatLng(z,a,r),d=s.pixelToLatLng(m,p,r);h.push({n:v.lat,s:d.lat,w:v.lng,e:d.lng,row:u,col:f})}return h}class Di{constructor(t,e={}){this.target=t,this.options={rows:e.rows??2,cols:e.cols??3,zoom:e.zoom??15,zoomDelta:e.zoomDelta??0,orientation:e.orientation??"portrait",provider:e.provider??"osm",dpi:e.dpi??300,filePrefix:e.filePrefix??"map",innerGrid:e.innerGrid??0},this.rows=this.options.rows,this.cols=this.options.cols,this.zoom=this.options.zoom,this.zoomDelta=this.options.zoomDelta,this.orientation=this.options.orientation,this.provider=this.options.provider,this.dpi=this.options.dpi,this.filePrefix=this.options.filePrefix??"map",this.innerGrid=this.options.innerGrid,this.p=null,this.p5Constructor=null,this.tileSystem=null,this.viewbox=null,this.center={lat:52.52,lng:13.405},this.stateSubscribers=new Set,this.shortcutListeners=new Set,this.viewport=null}async init(){if(!this.p){if(!this.p5Constructor){const t=await oi(()=>import("../chunks/DLNX37f0.js"),[],import.meta.url);this.p5Constructor=t.default}await new Promise(t=>{if(!this.p5Constructor)return t();this.p=new this.p5Constructor(e=>this.defineSketch(e,t),this.target)})}}defineSketch(t,e){t.setup=()=>{const i=this.target.getBoundingClientRect();t.createCanvas(Math.max(1,i.width),Math.max(1,i.height)),t.pixelDensity(1),this.tileSystem=new yi(t,this.provider),this.notifyState(),e()},t.windowResized=()=>{this.resize()},t.draw=()=>{this.render(t)},t.mouseDragged=()=>{this.handleDrag(t)},t.touchMoved=()=>(this.handleDrag(t),!1),t.keyPressed=()=>{t.key==="+"||t.key==="="?this.setZoom(this.zoom+1,t.width/2,t.height/2):(t.key==="-"||t.key==="_")&&this.setZoom(this.zoom-1,t.width/2,t.height/2)}}render(t){if(!this.tileSystem)return;t.background("azure");const e=this.computeGridFrame(t.width,t.height),i=Bt(this.tileSystem,this.center,this.zoom,e);this.applyViewport(i);const r=this.tileSystem.getTileSize(),{left:o,top:n,width:c,height:h}=i.pixelBounds,u=Math.floor(o/r),f=Math.floor((o+c)/r),z=Math.floor(n/r),a=Math.floor((n+h)/r),m=t.drawingContext;m.save(),m.beginPath(),m.rect(e.left,e.top,e.width,e.height),m.clip();for(let p=z;p<=a;p+=1)for(let v=u;v<=f;v+=1){const d=this.tileSystem.getTile(this.zoom,v,p);if(d.ready&&d.image){const G=v*r-o+e.left,T=p*r-n+e.top;t.image(d.image,G,T,r,r)}}m.restore(),this.drawGrid(t,e)}drawGrid(t,e){t.push(),t.stroke("blue"),t.noFill(),t.rect(e.left,e.top,e.width,e.height);const i=e.width/this.cols,r=e.height/this.rows,o=Math.min(18,Math.max(12,Math.min(i,r)*.12)),n=Math.round(o*.35);t.textSize(o),t.textAlign(t.LEFT,t.TOP);for(let c=0;c<=this.rows;c+=1){const h=e.top+c*r;t.line(e.left,h,e.left+e.width,h)}for(let c=0;c<=this.cols;c+=1){const h=e.left+c*i;t.line(h,e.top,h,e.top+e.height)}this.drawInnerGrid(t,e,i,r);for(let c=0;c<this.rows;c+=1)for(let h=0;h<this.cols;h+=1){const u=`${this.getColumnLabel(h)}${c+1}`,f=e.left+h*i+n,z=e.top+c*r+n,a=t.textWidth(u);t.noStroke(),t.fill("blue"),t.rect(f-n,z-n,a+n*2,o+n*2),t.fill("white"),t.text(u,f,z)}t.pop()}drawInnerGrid(t,e,i,r){const o=Math.max(0,Math.round(this.innerGrid));if(o<2)return;const n=i/o,c=r/o;t.push(),t.stroke("rgba(0, 0, 255, 0.35)"),t.strokeWeight(1);for(let h=0;h<this.rows;h+=1)for(let u=0;u<this.cols;u+=1){const f=e.left+u*i,z=e.top+h*r;for(let a=1;a<o;a+=1){const m=f+a*n;t.line(m,z,m,z+r)}for(let a=1;a<o;a+=1){const m=z+a*c;t.line(f,m,f+i,m)}}t.pop()}handleDrag(t){if(!this.tileSystem||Array.isArray(t.touches)&&t.touches.length>1)return;const e=this.screenToWorld(t.mouseX,t.mouseY),i=this.screenToWorld(t.pmouseX,t.pmouseY);this.center.lat+=i.lat-e.lat,this.center.lng+=i.lng-e.lng,this.center.lat=this.clampLatitude(this.center.lat),this.center.lng=this.normalizeLongitude(this.center.lng),this.invalidateViewport()}setZoom(t,e,i){if(!this.tileSystem||!this.p)return;const r=Math.max(1,Math.min(19,t));if(r===this.zoom)return;const o=this.screenToWorld(e,i);this.zoom=r;const n=this.screenToWorld(e,i);this.center.lat+=o.lat-n.lat,this.center.lng+=o.lng-n.lng,this.invalidateViewport(),this.notifyState()}zoomBy(t){if(!this.p)return;const e=this.p.width/2,i=this.p.height/2;this.setZoom(this.zoom+t,e,i)}screenToWorld(t,e){if(!this.tileSystem||!this.p)return this.center;const i=this.computeGridFrame(this.p.width,this.p.height),r=this.tileSystem.latLngToPixel(this.center.lng,this.center.lat,this.zoom),o=t-i.left,n=e-i.top,c=r.x-i.width/2+o,h=r.y-i.height/2+n;return this.tileSystem.pixelToLatLng(c,h,this.zoom)}cycleProvider(){const t=_t.findIndex(i=>i.key===this.provider),e=_t[(t+1)%_t.length];this.setProvider(e.key)}resize(t,e){if(!this.p)return;const i=this.target.getBoundingClientRect(),r=Math.max(1,t??i.width),o=Math.max(1,e??i.height);this.p.resizeCanvas(r,o),this.invalidateViewport()}applyViewport(t){this.viewport=t,this.viewbox={...t.latLngBounds},this.notifyState()}invalidateViewport(){this.viewport=null,this.viewbox=null}updateViewbox(t){if(!this.tileSystem||!this.p)return;let e=t;if(!e){const i=this.computeGridFrame(this.p.width,this.p.height);e=Bt(this.tileSystem,this.center,this.zoom,i)}this.applyViewport(e)}async exportGrid(){if(!this.tileSystem||!this.p)return;let t=this.viewport;if(!t){const i=this.computeGridFrame(this.p.width,this.p.height);t=Bt(this.tileSystem,this.center,this.zoom,i),this.applyViewport(t)}const e=Ci(this.tileSystem,t,this.rows,this.cols);await Pi(this.p,this.tileSystem,e,{rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,orientation:this.orientation,dpi:this.dpi,filePrefix:this.filePrefix,innerGrid:this.innerGrid})}setCenter(t,e,i){const r=this.clampLatitude(t),o=this.normalizeLongitude(e);this.center.lat=r,this.center.lng=o,typeof i=="number"&&(this.zoom=Math.max(1,Math.min(19,Math.round(i)))),this.invalidateViewport(),this.notifyState()}subscribe(t){return this.stateSubscribers.add(t),t(this.snapshot()),()=>{this.stateSubscribers.delete(t)}}onExportShortcut(t){return this.shortcutListeners.add(t),()=>{this.shortcutListeners.delete(t)}}triggerExportShortcut(){this.shortcutListeners.forEach(t=>t())}snapshot(){return{center:{...this.center},rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,provider:this.provider,orientation:this.orientation,innerGrid:this.innerGrid,viewbox:this.viewbox?{...this.viewbox}:null}}notifyState(){const t=this.snapshot();this.stateSubscribers.forEach(e=>e(t))}setGrid(t,e){const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(e));i===this.rows&&r===this.cols||(this.rows=i,this.cols=r,this.invalidateViewport(),this.notifyState())}setZoomDelta(t){const e=Math.max(0,Math.round(t));e!==this.zoomDelta&&(this.zoomDelta=e,this.notifyState())}setOrientation(t){t!==this.orientation&&(this.orientation=t,this.invalidateViewport(),this.notifyState())}setProvider(t){t!==this.provider&&(this.provider=t,this.tileSystem&&this.tileSystem.setProvider(t),this.invalidateViewport(),this.notifyState())}setDpi(t){t!==this.dpi&&(this.dpi=t)}setFilePrefix(t){this.filePrefix=t}setInnerGrid(t){const e=Math.max(0,Math.round(t));e!==this.innerGrid&&(this.innerGrid=e,this.notifyState())}destroy(){this.p&&this.p.remove(),this.p=null,this.tileSystem=null,this.stateSubscribers.clear(),this.shortcutListeners.clear()}getCellRatio(){return Mi(this.orientation)}computeGridFrame(t,e){const i=this.getCellRatio(),r=this.cols*i/Math.max(1,this.rows);let o=t,n=o/r;n>e&&(n=e,o=n*r);const c=(t-o)/2,h=(e-n)/2;return{left:c,top:h,width:o,height:n}}clampLatitude(t){return Math.max(-85,Math.min(85,t))}normalizeLongitude(t){let e=t%360;return e>180&&(e-=360),e<-180&&(e+=360),e}getColumnLabel(t){let e=Math.max(0,Math.floor(t)),i="";for(;e>=0;)i=String.fromCharCode(e%26+65)+i,e=Math.floor(e/26)-1;return i}}var ki=B('<div class="map-canvas svelte-4tz69q"><div class="zoom-controls svelte-4tz69q" aria-label="Map zoom controls"><button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom in">+</button> <button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom out">-</button></div></div>');function Ii(s,t){pe(t,!0);const e=k(t,"rows",3,2),i=k(t,"cols",3,3),r=k(t,"zoomDelta",3,0),o=k(t,"orientation",3,"portrait"),n=k(t,"provider",3,"osm"),c=k(t,"dpi",3,300),h=k(t,"filePrefix",3,"map"),u=k(t,"innerGrid",3,0),f=_e();let z=null,a=null,m=null;ni(()=>{if(!z)return;const E=new Di(z,{rows:e(),cols:i(),zoomDelta:r(),orientation:o(),provider:n(),dpi:c(),filePrefix:h(),innerGrid:u()}),N=[];return E.init().then(()=>f("ready",E)),N.push(E.subscribe(C=>f("state",C))),N.push(E.onExportShortcut(()=>f("exportshortcut"))),m=new ResizeObserver(C=>{if(!C.length)return;const{width:Y,height:X}=C[0].contentRect;E.resize(Y,X)}),m.observe(z),a=E,()=>{N.forEach(C=>C()),m?.disconnect(),E.destroy(),a=null}}),ai(()=>{m?.disconnect()}),$(()=>{a&&a.setGrid(e(),i())}),$(()=>{a&&a.setZoomDelta(r())}),$(()=>{a&&a.setOrientation(o())}),$(()=>{a&&a.setProvider(n())}),$(()=>{a&&a.setDpi(c())}),$(()=>{a&&a.setFilePrefix(h())}),$(()=>{a&&a.setInnerGrid(u())});function p(){a?.zoomBy(1)}function v(){a?.zoomBy(-1)}async function d(){a&&await a.exportGrid()}function G(E,N,C){a?.setCenter(E,N,C)}var T={exportGrid:d,focusOn:G},M=ki(),b=y(M),g=y(b);g.__click=p;var I=S(g,2);return I.__click=v,x(b),x(M),ge(M,E=>z=E,()=>z),A(s,M),me(T)}xe(["click"]);var Ni=B('<main class="page svelte-1uha8ag"><section class="panel svelte-1uha8ag"><!></section> <section class="canvas svelte-1uha8ag"><!></section></main>');function Hi(s){let t=W(2),e=W(2),i=W(0),r=W("portrait"),o=W("osm"),n=W(300),c=W("map"),h=W(0),u=W(!1),f=W(null),z=W(null);function a(b){const g=b.detail;typeof g.rows=="number"&&L(t,g.rows),typeof g.cols=="number"&&L(e,g.cols),typeof g.zoomDelta=="number"&&L(i,g.zoomDelta),g.orientation&&L(r,g.orientation),g.provider&&L(o,g.provider),typeof g.dpi=="number"&&L(n,g.dpi),g.filePrefix&&L(c,g.filePrefix),typeof g.innerGrid=="number"&&L(h,g.innerGrid)}async function m(){if(!(!_(f)||_(u))){L(u,!0);try{await _(f).exportGrid()}catch(b){console.error(b)}L(u,!1)}}function p(b){if(!_(f))return;const{lat:g,lng:I,zoom:E}=b.detail;_(f).focusOn(g,I,E)}var v=Ni(),d=y(v),G=y(d);{let b=gt(()=>_(z)?.zoom??15),g=gt(()=>_(z)?.viewbox??null),I=gt(()=>_(z)?.center??null);bi(G,{get rows(){return _(t)},get cols(){return _(e)},get zoomDelta(){return _(i)},get orientation(){return _(r)},get provider(){return _(o)},get zoom(){return _(b)},get viewbox(){return _(g)},get center(){return _(I)},get isExporting(){return _(u)},get dpi(){return _(n)},get filePrefix(){return _(c)},get innerGrid(){return _(h)},$$events:{change:a,export:m,locate:p}})}x(d);var T=S(d,2),M=y(T);ge(Ii(M,{get rows(){return _(t)},get cols(){return _(e)},get zoomDelta(){return _(i)},get orientation(){return _(r)},get provider(){return _(o)},get dpi(){return _(n)},get filePrefix(){return _(c)},get innerGrid(){return _(h)},$$events:{state:b=>L(z,b.detail),exportshortcut:m},$$legacy:!0}),b=>L(f,b),()=>_(f)),x(T),x(v),A(s,v)}export{Hi as component};
