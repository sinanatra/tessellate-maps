import{f as B,a as N,t as jt,c as $t}from"../chunks/BX9JqRfx.js";import"../chunks/C_mhSzNy.js";import{a as le,Q as Ne,P as Ft,h as $,G as Ie,M as Re,w as m,a1 as mt,S as ke,U as Fe,V as te,W as Gt,e as ht,ae as Ge,aD as Oe,b as Bt,s as Ve,c as Ae,al as Be,aG as A,ac as ee,aB as ce,k as he,aL as We,r as ue,p as He,aM as Ye,aN as Xe,aO as Ot,d as de,ax as Ze,aP as Ue,aA as qe,aQ as Qe,I as Je,as as Ke,aR as je,aS as $e,z as ve,aH as ut,a2 as ti,F as P,D as S,a3 as E,B as j,C as pe,E as y,am as ei,A as ft,u as et}from"../chunks/DaC0ZXKz.js";import{p as C,i as it,_ as ii,b as fe}from"../chunks/B19H37eM.js";import{c as me,o as ri,a as si}from"../chunks/Cv0Hl5ep.js";import{d as oi,e as ai,s as O}from"../chunks/BALP7dZq.js";import{r as rt,a as st}from"../chunks/BHoUpGYX.js";function ie(a,t){return t}function ni(a,t,e){for(var i=a.items,r=[],s=t.length,o=0;o<s;o++)Ue(t[o].e,r,!0);var f=s>0&&r.length===0&&e!==null;if(f){var p=e.parentNode;qe(p),p.append(e),i.clear(),H(a,t[0].prev,t[s-1].next)}Qe(r,()=>{for(var l=0;l<s;l++){var g=t[l];f||(i.delete(g.k),H(a,g.prev,g.next)),de(g.e,!f)}})}function re(a,t,e,i,r,s=null){var o=a,f={flags:t,items:new Map,first:null};{var p=a;o=$?Ft(Ie(p)):p.appendChild(le())}$&&Re();var l=null,g=!1,x=new Map,d=mt(()=>{var v=e();return he(v)?v:v==null?[]:ce(v)}),_,h;function u(){li(h,_,f,x,o,r,t,i,e),s!==null&&(_.length===0?l?ue(l):l=Bt(()=>s(o)):l!==null&&He(l,()=>{l=null}))}Ne(()=>{h??=Je,_=m(d);var v=_.length;if(g&&v===0)return;g=v===0;let b=!1;if($){var T=ke(o)===Fe;T!==(v===0)&&(o=te(),Ft(o),Gt(!1),b=!0)}if($){for(var c=null,w,D=0;D<v;D++){if(ht.nodeType===Ge&&ht.data===Oe){o=ht,b=!0,Gt(!1);break}var I=_[D],F=i(I,D);w=Wt(ht,f,c,null,I,F,D,r,t,e),f.items.set(F,w),c=w}v>0&&Ft(te())}if($)v===0&&s&&(l=Bt(()=>s(o)));else if(Ve()){var W=new Set,R=Ae;for(D=0;D<v;D+=1){I=_[D],F=i(I,D);var Z=f.items.get(F)??x.get(F);Z?ge(Z,I,D):(w=Wt(null,f,null,null,I,F,D,r,t,e,!0),x.set(F,w)),W.add(F)}for(const[U,Y]of f.items)W.has(U)||R.skipped_effects.add(Y.e);R.oncommit(u)}else u();b&&Gt(!0),m(d)}),$&&(o=ht)}function li(a,t,e,i,r,s,o,f,p){var l=t.length,g=e.items,x=e.first,d=x,_,h=null,u=[],v=[],b,T,c,w;for(w=0;w<l;w+=1){if(b=t[w],T=f(b,w),c=g.get(T),c===void 0){var D=i.get(T);if(D!==void 0){i.delete(T),g.set(T,D);var I=h?h.next:d;H(e,h,D),H(e,D,I),Vt(D,I,r),h=D}else{var F=d?d.e.nodes_start:r;h=Wt(F,e,h,h===null?e.first:h.next,b,T,w,s,o,p)}g.set(T,h),u=[],v=[],d=h.next;continue}if(ge(c,b,w),(c.e.f&Ot)!==0&&ue(c.e),c!==d){if(_!==void 0&&_.has(c)){if(u.length<v.length){var W=v[0],R;h=W.prev;var Z=u[0],U=u[u.length-1];for(R=0;R<u.length;R+=1)Vt(u[R],W,r);for(R=0;R<v.length;R+=1)_.delete(v[R]);H(e,Z.prev,U.next),H(e,h,Z),H(e,U,W),d=W,h=U,w-=1,u=[],v=[]}else _.delete(c),Vt(c,d,r),H(e,c.prev,c.next),H(e,c,h===null?e.first:h.next),H(e,h,c),h=c;continue}for(u=[],v=[];d!==null&&d.k!==T;)(d.e.f&Ot)===0&&(_??=new Set).add(d),v.push(d),d=d.next;if(d===null)continue;c=d}u.push(c),h=c,d=c.next}if(d!==null||_!==void 0){for(var Y=_===void 0?[]:ce(_);d!==null;)(d.e.f&Ot)===0&&Y.push(d),d=d.next;var ot=Y.length;if(ot>0){var tt=l===0?r:null;ni(e,Y,tt)}}a.first=e.first&&e.first.e,a.last=h&&h.e;for(var _t of i.values())de(_t.e);i.clear()}function ge(a,t,e,i){Be(a.v,t),a.i=e}function Wt(a,t,e,i,r,s,o,f,p,l,g){var x=(p&Ye)!==0,d=(p&Xe)===0,_=x?d?A(r,!1,!1):ee(r):r,h=(p&We)===0?o:ee(o),u={i:h,v:_,k:s,a:null,e:null,prev:e,next:i};try{if(a===null){var v=document.createDocumentFragment();v.append(a=le())}return u.e=Bt(()=>f(a,_,h,l),$),u.e.prev=e&&e.e,u.e.next=i&&i.e,e===null?g||(t.first=u):(e.next=u,e.e.next=u.e),i!==null&&(i.prev=u,i.e.prev=u.e),u}finally{}}function Vt(a,t,e){for(var i=a.next?a.next.e.nodes_start:e,r=t?t.e.nodes_start:e,s=a.e.nodes_start;s!==null&&s!==i;){var o=Ze(s);r.before(s),s=o}}function H(a,t,e){t===null?a.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Ht(a,t,e=!1){if(a.multiple){if(t==null)return;if(!he(t))return je();for(var i of a.options)i.selected=t.includes(oe(i));return}for(i of a.options){var r=oe(i);if($e(r,t)){i.selected=!0;return}}(!e||t!==void 0)&&(a.selectedIndex=-1)}function se(a){var t=new MutationObserver(()=>{Ht(a,a.__value)});t.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Ke(()=>{t.disconnect()})}function oe(a){return"__value"in a?a.__value:a.value}const _e={osm:{key:"osm",label:"OpenStreetMap",template:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors"},satellite:{key:"satellite",label:"ArcGIS World Imagery",template:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, Maxar, Earthstar Geographics",maxZoom:19}};function ae(a){return _e[a]}const gt=Object.values(_e);var ci=B("<option> </option>"),hi=B('<p class="search-error svelte-oydtmz"> </p>'),ui=B('<p class="search-message svelte-oydtmz"> </p>'),di=B('<li><button type="button" class="svelte-oydtmz"> </button></li>'),vi=B('<ul class="search-results svelte-oydtmz"></ul>'),pi=B("<div><span>Center Lat</span> <strong> </strong></div> <div><span>Center Lng</span> <strong> </strong></div>",1),fi=B("<div><span>North</span> <strong> </strong></div> <div><span>South</span> <strong> </strong></div> <div><span>West</span> <strong> </strong></div> <div><span>East</span> <strong> </strong></div>",1),mi=B('<div class="placeholder">Map loading… pan or zoom on canvas</div>'),gi=B('<section class="panel svelte-oydtmz"><header><div><h1 class="svelte-oydtmz">Tessellate Maps</h1></div> <button class="export svelte-oydtmz"><!></button></header> <div class="grid svelte-oydtmz"><label class="svelte-oydtmz"><span>Rows</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Cols</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Zoom +Δ</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Orientation</span> <select class="svelte-oydtmz"><option>Portrait</option><option>Landscape</option></select></label> <label class="svelte-oydtmz"><span>Provider</span> <select class="svelte-oydtmz"></select></label> <label class="svelte-oydtmz"><span>DPI</span> <input type="number" min="72" step="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>File Prefix</span> <input type="text" class="svelte-oydtmz"/></label></div> <form class="search svelte-oydtmz"><label class="svelte-oydtmz"><span>Jump to location</span> <div class="search-row svelte-oydtmz"><input type="text" placeholder="City, address or lat,lng" class="svelte-oydtmz"/> <button type="submit" class="svelte-oydtmz"> </button></div></label> <!></form> <div class="meta svelte-oydtmz"><div><span>Zoom</span> <strong> </strong></div> <!> <!></div> <footer class="svelte-oydtmz"><p class="svelte-oydtmz"><kbd>+/-</kbd> to zoom</p> <p class="svelte-oydtmz">Drag to pan the map</p></footer></section>');function _i(a,t){ve(t,!0);const e=C(t,"rows",3,2),i=C(t,"cols",3,2),r=C(t,"zoomDelta",3,1),s=C(t,"orientation",3,"portrait"),o=C(t,"provider",3,"osm"),f=C(t,"zoom",3,15),p=C(t,"viewbox",3,null),l=C(t,"center",3,null),g=C(t,"isExporting",3,!1),x=C(t,"dpi",3,300),d=C(t,"filePrefix",3,"map"),_=me();let h=ut(""),u=ut(ti([])),v=ut(!1),b=ut(""),T=ut("");function c(n,z){const M=Number.parseInt(z,10);if(Number.isNaN(M))return;const L=n==="dpi"?72:n==="zoomDelta"?0:1;_("change",{[n]:Math.max(L,M)})}function w(n){_("change",{orientation:n})}function D(n){_("change",{provider:n})}function I(n){const z=n.trim();_("change",{filePrefix:z||"map"})}function F(){_("export")}function W(n,z,M){_("locate",{lat:n,lng:z,label:M}),E(T,M?`Centered on ${M}`:`Centered on ${n.toFixed(4)}, ${z.toFixed(4)}`,!0)}function R(n){const z=n.split(/[,\s]+/).filter(Boolean);if(z.length<2)return null;const M=Number.parseFloat(z[0]),L=Number.parseFloat(z[1]);return Number.isNaN(M)||Number.isNaN(L)||M<-90||M>90||L<-180||L>180?null:{lat:M,lng:L}}async function Z(n){n?.preventDefault();const z=m(h).trim();if(E(b,""),E(u,[],!0),E(T,""),!z)return;const M=R(z);if(M){W(M.lat,M.lng);return}E(v,!0);try{const L=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=${encodeURIComponent(z)}`,{headers:{Accept:"application/json","User-Agent":"tessellate-maps/1.0 (https://github.com/giacomonanni/tessellate-maps)"}});if(!L.ok)throw new Error("Search failed");const V=await L.json();if(!V.length){E(T,"No results found."),E(v,!1);return}E(u,V,!0)}catch(L){console.error(L),E(b,"Unable to reach the geocoding service.")}E(v,!1)}function U(n){const z=Number.parseFloat(n.lat),M=Number.parseFloat(n.lon);Number.isNaN(z)||Number.isNaN(M)||(E(u,[],!0),E(h,n.display_name,!0),W(z,M,n.display_name))}var Y=gi(),ot=S(Y),tt=P(S(ot),2);tt.__click=F;var _t=S(tt);{var xe=n=>{var z=jt("Exporting…");N(n,z)},we=n=>{var z=jt("Export Grid");N(n,z)};it(_t,n=>{g()?n(xe):n(we,!1)})}y(tt),y(ot);var xt=P(ot,2),wt=S(xt),yt=P(S(wt),2);rt(yt),yt.__input=n=>c("rows",n.currentTarget.value),y(wt);var bt=P(wt,2),zt=P(S(bt),2);rt(zt),zt.__input=n=>c("cols",n.currentTarget.value),y(bt);var St=P(bt,2),Mt=P(S(St),2);rt(Mt),Mt.__input=n=>c("zoomDelta",n.currentTarget.value),y(St);var Pt=P(St,2),q=P(S(Pt),2);q.__change=n=>w(n.currentTarget.value);var Tt=S(q);Tt.value=Tt.__value="portrait";var Yt=P(Tt);Yt.value=Yt.__value="landscape",y(q);var Xt;se(q),y(Pt);var Dt=P(Pt,2),Q=P(S(Dt),2);Q.__change=n=>D(n.currentTarget.value),re(Q,21,()=>gt,ie,(n,z)=>{var M=ci(),L=S(M,!0);y(M);var V={};j(()=>{O(L,m(z).label),V!==(V=m(z).key)&&(M.value=(M.__value=m(z).key)??"")}),N(n,M)}),y(Q);var Zt;se(Q),y(Dt);var Et=P(Dt,2),Lt=P(S(Et),2);rt(Lt),Lt.__input=n=>c("dpi",n.currentTarget.value),y(Et);var Ut=P(Et,2),Ct=P(S(Ut),2);rt(Ct),Ct.__input=n=>I(n.currentTarget.value),y(Ut),y(xt);var dt=P(xt,2),Nt=S(dt),qt=P(S(Nt),2),vt=S(qt);rt(vt),vt.__input=n=>E(h,n.currentTarget.value,!0);var It=P(vt,2),ye=S(It,!0);y(It),y(qt),y(Nt);var be=P(Nt,2);{var ze=n=>{var z=hi(),M=S(z,!0);y(z),j(()=>O(M,m(b))),N(n,z)},Se=n=>{var z=$t(),M=ft(z);{var L=k=>{var G=ui(),J=S(G,!0);y(G),j(()=>O(J,m(T))),N(k,G)},V=k=>{var G=$t(),J=ft(G);{var K=X=>{var at=vi();re(at,21,()=>m(u),ie,(pt,nt)=>{var lt=di(),ct=S(lt);ct.__click=()=>U(m(nt));var kt=S(ct,!0);y(ct),y(lt),j(()=>O(kt,m(nt).display_name)),N(pt,lt)}),y(at),N(X,at)};it(J,X=>{m(u).length&&X(K)},!0)}N(k,G)};it(M,k=>{m(T)?k(L):k(V,!1)},!0)}N(n,z)};it(be,n=>{m(b)?n(ze):n(Se,!1)})}y(dt);var Qt=P(dt,2),Rt=S(Qt),Jt=P(S(Rt),2),Me=S(Jt);y(Jt),y(Rt);var Kt=P(Rt,2);{var Pe=n=>{var z=pi(),M=ft(z),L=P(S(M),2),V=S(L,!0);y(L),y(M);var k=P(M,2),G=P(S(k),2),J=S(G,!0);y(G),y(k),j((K,X)=>{O(V,K),O(J,X)},[()=>l().lat.toFixed(4),()=>l().lng.toFixed(4)]),N(n,z)};it(Kt,n=>{l()&&n(Pe)})}var Te=P(Kt,2);{var De=n=>{var z=fi(),M=ft(z),L=P(S(M),2),V=S(L,!0);y(L),y(M);var k=P(M,2),G=P(S(k),2),J=S(G,!0);y(G),y(k);var K=P(k,2),X=P(S(K),2),at=S(X,!0);y(X),y(K);var pt=P(K,2),nt=P(S(pt),2),lt=S(nt,!0);y(nt),y(pt),j((ct,kt,Le,Ce)=>{O(V,ct),O(J,kt),O(at,Le),O(lt,Ce)},[()=>p().n.toFixed(4),()=>p().s.toFixed(4),()=>p().w.toFixed(4),()=>p().e.toFixed(4)]),N(n,z)},Ee=n=>{var z=mi();N(n,z)};it(Te,n=>{p()?n(De):n(Ee,!1)})}y(Qt),ei(2),y(Y),j(()=>{tt.disabled=g(),st(yt,e()),st(zt,i()),st(Mt,r()),Xt!==(Xt=s())&&(q.value=(q.__value=s())??"",Ht(q,s())),Zt!==(Zt=o())&&(Q.value=(Q.__value=o())??"",Ht(Q,o())),st(Lt,x()),st(Ct,d()),st(vt,m(h)),It.disabled=m(v),O(ye,m(v)?"Searching…":"Go"),O(Me,`z${f()??""}`)}),ai("submit",dt,Z),N(a,Y),pe()}oi(["click","input","change"]);class xi{constructor(t,e){this.p=t,this.provider=ae(e),this.cache=new Map,this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.token=""}getTileSize(){return this.tileSize}setProvider(t){this.provider=ae(t),this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.cache.clear()}setApiToken(t){this.token=t,this.cache.clear()}latLngToPixel(t,e,i){const r=this.tileSize*Math.pow(2,i),s=(t+180)/360*r,o=Math.sin(e*Math.PI/180),f=(.5-Math.log((1+o)/(1-o))/(4*Math.PI))*r;return{x:s,y:f}}pixelToLatLng(t,e,i){const r=this.tileSize*Math.pow(2,i),s=t/r,o=e/r,f=s*360-180,p=Math.PI-2*Math.PI*o,l=180/Math.PI*Math.atan(.5*(Math.exp(p)-Math.exp(-p)));return{lng:f,lat:l}}getTile(t,e,i){const r=Math.pow(2,t),s=(e%r+r)%r,o=Math.max(0,Math.min(r-1,i)),f=`${this.provider.key}/${t}/${s}/${o}`,p=this.cache.get(f);if(p)return p;const l={image:null,ready:!1,failed:!1,waiters:[]};this.cache.set(f,l);const g=this.buildUrl(t,s,o);return this.p.loadImage(g,x=>{l.image=x,l.ready=!0,l.failed=!1,this.resolve(l)},()=>{l.ready=!0,l.failed=!0,this.resolve(l)}),l}resolve(t){t.waiters.length&&(t.waiters.forEach(e=>e()),t.waiters=[])}buildUrl(t,e,i){let r=this.template.replace("{z}",String(t)).replace("{x}",String(e)).replace("{y}",String(i));if(r.includes("{s}")&&this.subdomains.length){const s=Math.abs((e+i)%this.subdomains.length);r=r.replace("{s}",this.subdomains[s])}return r.includes("{token}")&&(r=r.replace("{token}",encodeURIComponent(this.token))),r}}function wi(a){return a.ready?Promise.resolve():new Promise(t=>{a.waiters.push(t)})}const ne=25.4;function yi(a,t){const e=a==="portrait"?210:297,i=a==="portrait"?297:210;return{widthPx:Math.round(e/ne*t),heightPx:Math.round(i/ne*t)}}function bi(a){return a==="portrait"?210/297:297/210}async function zi(a,t,e,i){const r=t.getTileSize(),s=t.latLngToPixel(e.w,e.n,i),o=t.latLngToPixel(e.e,e.s,i),f=Math.floor(s.x/r),p=Math.floor(o.x/r),l=Math.floor(s.y/r),g=Math.floor(o.y/r),x=s.x,d=s.y,_=Math.max(1,Math.ceil(o.x-s.x)),h=Math.max(1,Math.ceil(o.y-s.y)),u=a.createGraphics(_,h);for(let v=l;v<=g;v+=1)for(let b=f;b<=p;b+=1){const T=t.getTile(i,b,v);if(await wi(T),T.ready&&T.image){const c=b*r-x,w=v*r-d;u.image(T.image,c,w,r,r)}}return u}async function Si(a,t,e,i){const{rows:r,cols:s,zoom:o,zoomDelta:f,orientation:p,dpi:l,filePrefix:g="map"}=i,x=Math.min(19,o+f),{widthPx:d,heightPx:_}=yi(p,l);for(let h=0;h<r;h+=1)for(let u=0;u<s;u+=1){const v=h*s+u,b=e[v],T=await zi(a,t,{n:b.n,s:b.s,w:b.w,e:b.e},x),c=a.createGraphics(d,_);c.image(T,0,0,d,_);const w=`${g}_${String(h+1).padStart(2,"0")}_${String(u+1).padStart(2,"0")}_${p}_z${x}.png`;a.save(c,w),await Mi(140)}}function Mi(a){return new Promise(t=>setTimeout(t,a))}function At(a,t,e,i){const r=a.latLngToPixel(t.lng,t.lat,e),s=r.x-i.width/2,o=r.y-i.height/2,f=s+i.width,p=o+i.height,l=a.pixelToLatLng(s,o,e),g=a.pixelToLatLng(f,p,e);return{zoom:e,pixelBounds:{left:s,top:o,width:i.width,height:i.height},latLngBounds:{n:l.lat,s:g.lat,w:l.lng,e:g.lng},centerPixel:r}}function Pi(a,t,e,i){const{zoom:r,pixelBounds:s}=t,o=s.width/i,f=s.height/e,p=[];for(let l=0;l<e;l+=1)for(let g=0;g<i;g+=1){const x=s.left+g*o,d=s.top+l*f,_=x+o,h=d+f,u=a.pixelToLatLng(x,d,r),v=a.pixelToLatLng(_,h,r);p.push({n:u.lat,s:v.lat,w:u.lng,e:v.lng,row:l,col:g})}return p}class Ti{constructor(t,e={}){this.target=t,this.options={rows:e.rows??2,cols:e.cols??3,zoom:e.zoom??15,zoomDelta:e.zoomDelta??0,orientation:e.orientation??"portrait",provider:e.provider??"osm",dpi:e.dpi??300,filePrefix:e.filePrefix??"map"},this.rows=this.options.rows,this.cols=this.options.cols,this.zoom=this.options.zoom,this.zoomDelta=this.options.zoomDelta,this.orientation=this.options.orientation,this.provider=this.options.provider,this.dpi=this.options.dpi,this.filePrefix=this.options.filePrefix??"map",this.p=null,this.p5Constructor=null,this.tileSystem=null,this.viewbox=null,this.center={lat:52.52,lng:13.405},this.stateSubscribers=new Set,this.shortcutListeners=new Set,this.viewport=null}async init(){if(!this.p){if(!this.p5Constructor){const t=await ii(()=>import("../chunks/DLNX37f0.js"),[],import.meta.url);this.p5Constructor=t.default}await new Promise(t=>{if(!this.p5Constructor)return t();this.p=new this.p5Constructor(e=>this.defineSketch(e,t),this.target)})}}defineSketch(t,e){t.setup=()=>{const i=this.target.getBoundingClientRect();t.createCanvas(Math.max(1,i.width),Math.max(1,i.height)),t.pixelDensity(1),this.tileSystem=new xi(t,this.provider),this.notifyState(),e()},t.windowResized=()=>{this.resize()},t.draw=()=>{this.render(t)},t.mouseDragged=()=>{this.handleDrag(t)},t.keyPressed=()=>{t.key==="+"||t.key==="="?this.setZoom(this.zoom+1,t.width/2,t.height/2):(t.key==="-"||t.key==="_")&&this.setZoom(this.zoom-1,t.width/2,t.height/2)}}render(t){if(!this.tileSystem)return;t.background("azure");const e=this.computeGridFrame(t.width,t.height),i=At(this.tileSystem,this.center,this.zoom,e);this.applyViewport(i);const r=this.tileSystem.getTileSize(),{left:s,top:o,width:f,height:p}=i.pixelBounds,l=Math.floor(s/r),g=Math.floor((s+f)/r),x=Math.floor(o/r),d=Math.floor((o+p)/r),_=t.drawingContext;_.save(),_.beginPath(),_.rect(e.left,e.top,e.width,e.height),_.clip();for(let h=x;h<=d;h+=1)for(let u=l;u<=g;u+=1){const v=this.tileSystem.getTile(this.zoom,u,h);if(v.ready&&v.image){const b=u*r-s+e.left,T=h*r-o+e.top;t.image(v.image,b,T,r,r)}}_.restore(),this.drawGrid(t,e)}drawGrid(t,e){t.stroke("blue"),t.noFill(),t.rect(e.left,e.top,e.width,e.height);const i=e.width/this.cols,r=e.height/this.rows;for(let s=0;s<=this.rows;s+=1){const o=e.top+s*r;t.line(e.left,o,e.left+e.width,o)}for(let s=0;s<=this.cols;s+=1){const o=e.left+s*i;t.line(o,e.top,o,e.top+e.height)}}handleDrag(t){if(!this.tileSystem)return;const e=this.screenToWorld(t.mouseX,t.mouseY),i=this.screenToWorld(t.pmouseX,t.pmouseY);this.center.lat+=i.lat-e.lat,this.center.lng+=i.lng-e.lng,this.center.lat=this.clampLatitude(this.center.lat),this.center.lng=this.normalizeLongitude(this.center.lng),this.invalidateViewport()}setZoom(t,e,i){if(!this.tileSystem||!this.p)return;const r=Math.max(1,Math.min(19,t));if(r===this.zoom)return;const s=this.screenToWorld(e,i);this.zoom=r;const o=this.screenToWorld(e,i);this.center.lat+=s.lat-o.lat,this.center.lng+=s.lng-o.lng,this.invalidateViewport(),this.notifyState()}screenToWorld(t,e){if(!this.tileSystem||!this.p)return this.center;const i=this.computeGridFrame(this.p.width,this.p.height),r=this.tileSystem.latLngToPixel(this.center.lng,this.center.lat,this.zoom),s=t-i.left,o=e-i.top,f=r.x-i.width/2+s,p=r.y-i.height/2+o;return this.tileSystem.pixelToLatLng(f,p,this.zoom)}cycleProvider(){const t=gt.findIndex(i=>i.key===this.provider),e=gt[(t+1)%gt.length];this.setProvider(e.key)}resize(t,e){if(!this.p)return;const i=this.target.getBoundingClientRect(),r=Math.max(1,t??i.width),s=Math.max(1,e??i.height);this.p.resizeCanvas(r,s),this.invalidateViewport()}applyViewport(t){this.viewport=t,this.viewbox={...t.latLngBounds},this.notifyState()}invalidateViewport(){this.viewport=null,this.viewbox=null}updateViewbox(t){if(!this.tileSystem||!this.p)return;let e=t;if(!e){const i=this.computeGridFrame(this.p.width,this.p.height);e=At(this.tileSystem,this.center,this.zoom,i)}this.applyViewport(e)}async exportGrid(){if(!this.tileSystem||!this.p)return;let t=this.viewport;if(!t){const i=this.computeGridFrame(this.p.width,this.p.height);t=At(this.tileSystem,this.center,this.zoom,i),this.applyViewport(t)}const e=Pi(this.tileSystem,t,this.rows,this.cols);await Si(this.p,this.tileSystem,e,{rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,orientation:this.orientation,dpi:this.dpi,filePrefix:this.filePrefix})}setCenter(t,e,i){const r=this.clampLatitude(t),s=this.normalizeLongitude(e);this.center.lat=r,this.center.lng=s,typeof i=="number"&&(this.zoom=Math.max(1,Math.min(19,Math.round(i)))),this.invalidateViewport(),this.notifyState()}subscribe(t){return this.stateSubscribers.add(t),t(this.snapshot()),()=>{this.stateSubscribers.delete(t)}}onExportShortcut(t){return this.shortcutListeners.add(t),()=>{this.shortcutListeners.delete(t)}}triggerExportShortcut(){this.shortcutListeners.forEach(t=>t())}snapshot(){return{center:{...this.center},rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,provider:this.provider,orientation:this.orientation,viewbox:this.viewbox?{...this.viewbox}:null}}notifyState(){const t=this.snapshot();this.stateSubscribers.forEach(e=>e(t))}setGrid(t,e){const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(e));i===this.rows&&r===this.cols||(this.rows=i,this.cols=r,this.invalidateViewport(),this.notifyState())}setZoomDelta(t){const e=Math.max(0,Math.round(t));e!==this.zoomDelta&&(this.zoomDelta=e,this.notifyState())}setOrientation(t){t!==this.orientation&&(this.orientation=t,this.invalidateViewport(),this.notifyState())}setProvider(t){t!==this.provider&&(this.provider=t,this.tileSystem&&this.tileSystem.setProvider(t),this.invalidateViewport(),this.notifyState())}setDpi(t){t!==this.dpi&&(this.dpi=t)}setFilePrefix(t){this.filePrefix=t}destroy(){this.p&&this.p.remove(),this.p=null,this.tileSystem=null,this.stateSubscribers.clear(),this.shortcutListeners.clear()}getCellRatio(){return bi(this.orientation)}computeGridFrame(t,e){const i=this.getCellRatio(),r=this.cols*i/Math.max(1,this.rows);let s=t,o=s/r;o>e&&(o=e,s=o*r);const f=(t-s)/2,p=(e-o)/2;return{left:f,top:p,width:s,height:o}}clampLatitude(t){return Math.max(-85,Math.min(85,t))}normalizeLongitude(t){let e=t%360;return e>180&&(e-=360),e<-180&&(e+=360),e}}var Di=B('<div class="map-canvas svelte-4tz69q"></div>');function Ei(a,t){ve(t,!0);const e=C(t,"rows",3,2),i=C(t,"cols",3,3),r=C(t,"zoomDelta",3,0),s=C(t,"orientation",3,"portrait"),o=C(t,"provider",3,"osm"),f=C(t,"dpi",3,300),p=C(t,"filePrefix",3,"map"),l=me();let g=null,x=null,d=null;ri(()=>{if(!g)return;const b=new Ti(g,{rows:e(),cols:i(),zoomDelta:r(),orientation:s(),provider:o(),dpi:f(),filePrefix:p()}),T=[];return b.init().then(()=>l("ready",b)),T.push(b.subscribe(c=>l("state",c))),T.push(b.onExportShortcut(()=>l("exportshortcut"))),d=new ResizeObserver(c=>{if(!c.length)return;const{width:w,height:D}=c[0].contentRect;b.resize(w,D)}),d.observe(g),x=b,()=>{T.forEach(c=>c()),d?.disconnect(),b.destroy(),x=null}}),si(()=>{d?.disconnect()}),et(()=>{x&&x.setGrid(e(),i())}),et(()=>{x&&x.setZoomDelta(r())}),et(()=>{x&&x.setOrientation(s())}),et(()=>{x&&x.setProvider(o())}),et(()=>{x&&x.setDpi(f())}),et(()=>{x&&x.setFilePrefix(p())});async function _(){x&&await x.exportGrid()}function h(b,T,c){x?.setCenter(b,T,c)}var u={exportGrid:_,focusOn:h},v=Di();return fe(v,b=>g=b,()=>g),N(a,v),pe(u)}var Li=B('<main class="page svelte-1uha8ag"><section class="panel svelte-1uha8ag"><!></section> <section class="canvas svelte-1uha8ag"><!></section></main>');function Oi(a){let t=A(2),e=A(2),i=A(0),r=A("portrait"),s=A("osm"),o=A(300),f=A("map"),p=A(!1),l=A(null),g=A(null);function x(c){const w=c.detail;typeof w.rows=="number"&&E(t,w.rows),typeof w.cols=="number"&&E(e,w.cols),typeof w.zoomDelta=="number"&&E(i,w.zoomDelta),w.orientation&&E(r,w.orientation),w.provider&&E(s,w.provider),typeof w.dpi=="number"&&E(o,w.dpi),w.filePrefix&&E(f,w.filePrefix)}async function d(){if(!(!m(l)||m(p))){E(p,!0);try{await m(l).exportGrid()}catch(c){console.error(c)}E(p,!1)}}function _(c){if(!m(l))return;const{lat:w,lng:D,zoom:I}=c.detail;m(l).focusOn(w,D,I)}var h=Li(),u=S(h),v=S(u);{let c=mt(()=>m(g)?.zoom??15),w=mt(()=>m(g)?.viewbox??null),D=mt(()=>m(g)?.center??null);_i(v,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get zoom(){return m(c)},get viewbox(){return m(w)},get center(){return m(D)},get isExporting(){return m(p)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{change:x,export:d,locate:_}})}y(u);var b=P(u,2),T=S(b);fe(Ei(T,{get rows(){return m(t)},get cols(){return m(e)},get zoomDelta(){return m(i)},get orientation(){return m(r)},get provider(){return m(s)},get dpi(){return m(o)},get filePrefix(){return m(f)},$$events:{state:c=>E(g,c.detail),exportshortcut:d},$$legacy:!0}),c=>E(l,c),()=>m(l)),y(b),y(h),N(a,h)}export{Oi as component};
