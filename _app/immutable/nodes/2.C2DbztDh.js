import{f as B,a as G,t as jt,c as $t}from"../chunks/BX9JqRfx.js";import"../chunks/C_mhSzNy.js";import{a as le,Q as Ie,P as Gt,h as $,G as Ne,M as Ae,w as _,a1 as mt,S as Ge,U as Re,V as te,W as Rt,e as ht,ae as Oe,aD as Fe,b as Wt,s as Ve,c as We,al as Be,aG as W,ac as ee,aB as ce,k as he,aL as He,r as ue,p as Ye,aM as Xe,aN as Ze,aO as Ot,d as de,ax as Ue,aP as qe,aA as Qe,aQ as Je,I as Ke,as as je,aR as $e,aS as ti,z as ve,aH as ut,a2 as ei,F as M,D as w,a3 as C,B as j,C as pe,E as x,A as ft,u as et}from"../chunks/DaC0ZXKz.js";import{p as N,i as it,_ as ii,b as fe}from"../chunks/B19H37eM.js";import{c as me,o as ri,a as si}from"../chunks/Cv0Hl5ep.js";import{d as ge,e as oi,s as F}from"../chunks/BALP7dZq.js";import{r as rt,a as st}from"../chunks/BHoUpGYX.js";function ie(s,t){return t}function ai(s,t,e){for(var i=s.items,r=[],o=t.length,a=0;a<o;a++)qe(t[a].e,r,!0);var l=o>0&&r.length===0&&e!==null;if(l){var h=e.parentNode;Qe(h),h.append(e),i.clear(),H(s,t[0].prev,t[o-1].next)}Je(r,()=>{for(var c=0;c<o;c++){var m=t[c];l||(i.delete(m.k),H(s,m.prev,m.next)),de(m.e,!l)}})}function re(s,t,e,i,r,o=null){var a=s,l={flags:t,items:new Map,first:null};{var h=s;a=$?Gt(Ne(h)):h.appendChild(le())}$&&Ae();var c=null,m=!1,g=new Map,v=mt(()=>{var p=e();return he(p)?p:p==null?[]:ce(p)}),b,u;function d(){ni(u,b,l,g,a,r,t,i,e),o!==null&&(b.length===0?c?ue(c):c=Wt(()=>o(a)):c!==null&&Ye(c,()=>{c=null}))}Ie(()=>{u??=Ke,b=_(v);var p=b.length;if(m&&p===0)return;m=p===0;let T=!1;if($){var P=Ge(a)===Re;P!==(p===0)&&(a=te(),Gt(a),Rt(!1),T=!0)}if($){for(var f=null,y,E=0;E<p;E++){if(ht.nodeType===Oe&&ht.data===Fe){a=ht,T=!0,Rt(!1);break}var L=b[E],I=i(L,E);y=Bt(ht,l,f,null,L,I,E,r,t,e),l.items.set(I,y),f=y}p>0&&Gt(te())}if($)p===0&&o&&(c=Wt(()=>o(a)));else if(Ve()){var k=new Set,A=We;for(E=0;E<p;E+=1){L=b[E],I=i(L,E);var Y=l.items.get(I)??g.get(I);Y?_e(Y,L,E):(y=Bt(null,l,null,null,L,I,E,r,t,e,!0),g.set(I,y)),k.add(I)}for(const[U,X]of l.items)k.has(U)||A.skipped_effects.add(X.e);A.oncommit(d)}else d();T&&Rt(!0),_(v)}),$&&(a=ht)}function ni(s,t,e,i,r,o,a,l,h){var c=t.length,m=e.items,g=e.first,v=g,b,u=null,d=[],p=[],T,P,f,y;for(y=0;y<c;y+=1){if(T=t[y],P=l(T,y),f=m.get(P),f===void 0){var E=i.get(P);if(E!==void 0){i.delete(P),m.set(P,E);var L=u?u.next:v;H(e,u,E),H(e,E,L),Ft(E,L,r),u=E}else{var I=v?v.e.nodes_start:r;u=Bt(I,e,u,u===null?e.first:u.next,T,P,y,o,a,h)}m.set(P,u),d=[],p=[],v=u.next;continue}if(_e(f,T,y),(f.e.f&Ot)!==0&&ue(f.e),f!==v){if(b!==void 0&&b.has(f)){if(d.length<p.length){var k=p[0],A;u=k.prev;var Y=d[0],U=d[d.length-1];for(A=0;A<d.length;A+=1)Ft(d[A],k,r);for(A=0;A<p.length;A+=1)b.delete(p[A]);H(e,Y.prev,U.next),H(e,u,Y),H(e,U,k),v=k,u=U,y-=1,d=[],p=[]}else b.delete(f),Ft(f,v,r),H(e,f.prev,f.next),H(e,f,u===null?e.first:u.next),H(e,u,f),u=f;continue}for(d=[],p=[];v!==null&&v.k!==P;)(v.e.f&Ot)===0&&(b??=new Set).add(v),p.push(v),v=v.next;if(v===null)continue;f=v}d.push(f),u=f,v=f.next}if(v!==null||b!==void 0){for(var X=b===void 0?[]:ce(b);v!==null;)(v.e.f&Ot)===0&&X.push(v),v=v.next;var ot=X.length;if(ot>0){var tt=c===0?r:null;ai(e,X,tt)}}s.first=e.first&&e.first.e,s.last=u&&u.e;for(var _t of i.values())de(_t.e);i.clear()}function _e(s,t,e,i){Be(s.v,t),s.i=e}function Bt(s,t,e,i,r,o,a,l,h,c,m){var g=(h&Xe)!==0,v=(h&Ze)===0,b=g?v?W(r,!1,!1):ee(r):r,u=(h&He)===0?a:ee(a),d={i:u,v:b,k:o,a:null,e:null,prev:e,next:i};try{if(s===null){var p=document.createDocumentFragment();p.append(s=le())}return d.e=Wt(()=>l(s,b,u,c),$),d.e.prev=e&&e.e,d.e.next=i&&i.e,e===null?m||(t.first=d):(e.next=d,e.e.next=d.e),i!==null&&(i.prev=d,i.e.prev=d.e),d}finally{}}function Ft(s,t,e){for(var i=s.next?s.next.e.nodes_start:e,r=t?t.e.nodes_start:e,o=s.e.nodes_start;o!==null&&o!==i;){var a=Ue(o);r.before(o),o=a}}function H(s,t,e){t===null?s.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function Ht(s,t,e=!1){if(s.multiple){if(t==null)return;if(!he(t))return $e();for(var i of s.options)i.selected=t.includes(oe(i));return}for(i of s.options){var r=oe(i);if(ti(r,t)){i.selected=!0;return}}(!e||t!==void 0)&&(s.selectedIndex=-1)}function se(s){var t=new MutationObserver(()=>{Ht(s,s.__value)});t.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),je(()=>{t.disconnect()})}function oe(s){return"__value"in s?s.__value:s.value}const xe={osm:{key:"osm",label:"OpenStreetMap",template:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors"},satellite:{key:"satellite",label:"ArcGIS World Imagery",template:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, Maxar, Earthstar Geographics",maxZoom:19},cartoLight:{key:"cartoLight",label:"CARTO Positron",template:"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",subdomains:["a","b","c","d"],attribution:"© OpenStreetMap contributors, © CARTO"},osmHot:{key:"osmHot",label:"OSM Humanitarian",template:"https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",subdomains:["a","b","c"],attribution:"© OpenStreetMap contributors, Humanitarian style"},esriTopo:{key:"esriTopo",label:"Esri World Topographic",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"},esriGray:{key:"esriGray",label:"Esri Light Gray",template:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri | Esri Light Gray Canvas"},esriStreets:{key:"esriStreets",label:"Esri World Street Map",template:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Source: Esri, HERE, Garmin, FAO, NOAA, USGS | Tiles © Esri"}};function ae(s){return xe[s]}const gt=Object.values(xe).filter(s=>!s.requiresToken||!!s.token);var li=B("<option> </option>"),ci=B('<p class="search-error svelte-oydtmz"> </p>'),hi=B('<p class="search-message svelte-oydtmz"> </p>'),ui=B('<li><button type="button" class="svelte-oydtmz"> </button></li>'),di=B('<ul class="search-results svelte-oydtmz"></ul>'),vi=B("<div><span>Center Lat</span> <strong> </strong></div> <div><span>Center Lng</span> <strong> </strong></div>",1),pi=B("<div><span>North</span> <strong> </strong></div> <div><span>South</span> <strong> </strong></div> <div><span>West</span> <strong> </strong></div> <div><span>East</span> <strong> </strong></div>",1),fi=B('<div class="placeholder">Map loading… pan or zoom on canvas</div>'),mi=B('<section class="panel svelte-oydtmz"><header><div><h1 class="svelte-oydtmz">Export map tiles into <br/> a printable A4 grid</h1></div> <button class="export svelte-oydtmz"><!></button></header> <div class="grid svelte-oydtmz"><label class="svelte-oydtmz"><span>Rows</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Cols</span> <input type="number" min="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Zoom +Δ</span> <input type="number" min="0" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>Orientation</span> <select class="svelte-oydtmz"><option>Portrait</option><option>Landscape</option></select></label> <label class="svelte-oydtmz"><span>Provider</span> <select class="svelte-oydtmz"></select></label> <label class="svelte-oydtmz"><span>DPI</span> <input type="number" min="72" step="1" class="svelte-oydtmz"/></label> <label class="svelte-oydtmz"><span>File Prefix</span> <input type="text" class="svelte-oydtmz"/></label></div> <form class="search svelte-oydtmz"><label class="svelte-oydtmz"><span>Jump to location</span> <div class="search-row svelte-oydtmz"><input type="text" placeholder="City, address or lat,lng" class="svelte-oydtmz"/> <button type="submit" class="svelte-oydtmz"> </button></div></label> <!></form> <div class="meta svelte-oydtmz"><div><span>Zoom</span> <strong> </strong></div> <!> <!></div></section>');function gi(s,t){ve(t,!0);const e=N(t,"rows",3,2),i=N(t,"cols",3,2),r=N(t,"zoomDelta",3,1),o=N(t,"orientation",3,"portrait"),a=N(t,"provider",3,"osm"),l=N(t,"zoom",3,15),h=N(t,"viewbox",3,null),c=N(t,"center",3,null),m=N(t,"isExporting",3,!1),g=N(t,"dpi",3,300),v=N(t,"filePrefix",3,"map"),b=me();let u=ut(""),d=ut(ei([])),p=ut(!1),T=ut(""),P=ut("");function f(n,z){const S=Number.parseInt(z,10);if(Number.isNaN(S))return;const D=n==="dpi"?72:n==="zoomDelta"?0:1;b("change",{[n]:Math.max(D,S)})}function y(n){b("change",{orientation:n})}function E(n){b("change",{provider:n})}function L(n){const z=n.trim();b("change",{filePrefix:z||"map"})}function I(){b("export")}function k(n,z,S){b("locate",{lat:n,lng:z,label:S}),C(P,S?`Centered on ${S}`:`Centered on ${n.toFixed(4)}, ${z.toFixed(4)}`,!0)}function A(n){const z=n.split(/[,\s]+/).filter(Boolean);if(z.length<2)return null;const S=Number.parseFloat(z[0]),D=Number.parseFloat(z[1]);return Number.isNaN(S)||Number.isNaN(D)||S<-90||S>90||D<-180||D>180?null:{lat:S,lng:D}}async function Y(n){n?.preventDefault();const z=_(u).trim();if(C(T,""),C(d,[],!0),C(P,""),!z)return;const S=A(z);if(S){k(S.lat,S.lng);return}C(p,!0);try{const D=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=${encodeURIComponent(z)}`,{headers:{Accept:"application/json","User-Agent":"tessellate-maps/1.0 (https://github.com/giacomonanni/tessellate-maps)"}});if(!D.ok)throw new Error("Search failed");const V=await D.json();if(!V.length){C(P,"No results found."),C(p,!1);return}C(d,V,!0)}catch(D){console.error(D),C(T,"Unable to reach the geocoding service.")}C(p,!1)}function U(n){const z=Number.parseFloat(n.lat),S=Number.parseFloat(n.lon);Number.isNaN(z)||Number.isNaN(S)||(C(d,[],!0),C(u,n.display_name,!0),k(z,S,n.display_name))}var X=mi(),ot=w(X),tt=M(w(ot),2);tt.__click=I;var _t=w(tt);{var be=n=>{var z=jt("Exporting…");G(n,z)},ye=n=>{var z=jt("Export Grid");G(n,z)};it(_t,n=>{m()?n(be):n(ye,!1)})}x(tt),x(ot);var xt=M(ot,2),bt=w(xt),yt=M(w(bt),2);rt(yt),yt.__input=n=>f("rows",n.currentTarget.value),x(bt);var wt=M(bt,2),zt=M(w(wt),2);rt(zt),zt.__input=n=>f("cols",n.currentTarget.value),x(wt);var St=M(wt,2),Mt=M(w(St),2);rt(Mt),Mt.__input=n=>f("zoomDelta",n.currentTarget.value),x(St);var Pt=M(St,2),q=M(w(Pt),2);q.__change=n=>y(n.currentTarget.value);var Tt=w(q);Tt.value=Tt.__value="portrait";var Yt=M(Tt);Yt.value=Yt.__value="landscape",x(q);var Xt;se(q),x(Pt);var Et=M(Pt,2),Q=M(w(Et),2);Q.__change=n=>E(n.currentTarget.value),re(Q,21,()=>gt,ie,(n,z)=>{var S=li(),D=w(S,!0);x(S);var V={};j(()=>{F(D,_(z).label),V!==(V=_(z).key)&&(S.value=(S.__value=_(z).key)??"")}),G(n,S)}),x(Q);var Zt;se(Q),x(Et);var Lt=M(Et,2),Ct=M(w(Lt),2);rt(Ct),Ct.__input=n=>f("dpi",n.currentTarget.value),x(Lt);var Ut=M(Lt,2),Dt=M(w(Ut),2);rt(Dt),Dt.__input=n=>L(n.currentTarget.value),x(Ut),x(xt);var dt=M(xt,2),kt=w(dt),qt=M(w(kt),2),vt=w(qt);rt(vt),vt.__input=n=>C(u,n.currentTarget.value,!0);var It=M(vt,2),we=w(It,!0);x(It),x(qt),x(kt);var ze=M(kt,2);{var Se=n=>{var z=ci(),S=w(z,!0);x(z),j(()=>F(S,_(T))),G(n,z)},Me=n=>{var z=$t(),S=ft(z);{var D=R=>{var O=hi(),J=w(O,!0);x(O),j(()=>F(J,_(P))),G(R,O)},V=R=>{var O=$t(),J=ft(O);{var K=Z=>{var at=di();re(at,21,()=>_(d),ie,(pt,nt)=>{var lt=ui(),ct=w(lt);ct.__click=()=>U(_(nt));var At=w(ct,!0);x(ct),x(lt),j(()=>F(At,_(nt).display_name)),G(pt,lt)}),x(at),G(Z,at)};it(J,Z=>{_(d).length&&Z(K)},!0)}G(R,O)};it(S,R=>{_(P)?R(D):R(V,!1)},!0)}G(n,z)};it(ze,n=>{_(T)?n(Se):n(Me,!1)})}x(dt);var Qt=M(dt,2),Nt=w(Qt),Jt=M(w(Nt),2),Pe=w(Jt);x(Jt),x(Nt);var Kt=M(Nt,2);{var Te=n=>{var z=vi(),S=ft(z),D=M(w(S),2),V=w(D,!0);x(D),x(S);var R=M(S,2),O=M(w(R),2),J=w(O,!0);x(O),x(R),j((K,Z)=>{F(V,K),F(J,Z)},[()=>c().lat.toFixed(4),()=>c().lng.toFixed(4)]),G(n,z)};it(Kt,n=>{c()&&n(Te)})}var Ee=M(Kt,2);{var Le=n=>{var z=pi(),S=ft(z),D=M(w(S),2),V=w(D,!0);x(D),x(S);var R=M(S,2),O=M(w(R),2),J=w(O,!0);x(O),x(R);var K=M(R,2),Z=M(w(K),2),at=w(Z,!0);x(Z),x(K);var pt=M(K,2),nt=M(w(pt),2),lt=w(nt,!0);x(nt),x(pt),j((ct,At,De,ke)=>{F(V,ct),F(J,At),F(at,De),F(lt,ke)},[()=>h().n.toFixed(4),()=>h().s.toFixed(4),()=>h().w.toFixed(4),()=>h().e.toFixed(4)]),G(n,z)},Ce=n=>{var z=fi();G(n,z)};it(Ee,n=>{h()?n(Le):n(Ce,!1)})}x(Qt),x(X),j(()=>{tt.disabled=m(),st(yt,e()),st(zt,i()),st(Mt,r()),Xt!==(Xt=o())&&(q.value=(q.__value=o())??"",Ht(q,o())),Zt!==(Zt=a())&&(Q.value=(Q.__value=a())??"",Ht(Q,a())),st(Ct,g()),st(Dt,v()),st(vt,_(u)),It.disabled=_(p),F(we,_(p)?"Searching…":"Go"),F(Pe,`z${l()??""}`)}),oi("submit",dt,Y),G(s,X),pe()}ge(["click","input","change"]);class _i{constructor(t,e){this.p=t,this.provider=ae(e),this.cache=new Map,this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.token=""}getTileSize(){return this.tileSize}setProvider(t){this.provider=ae(t),this.template=this.provider.template,this.subdomains=this.provider.subdomains??[],this.tileSize=this.provider.tileSize??256,this.cache.clear()}setApiToken(t){this.token=t,this.cache.clear()}latLngToPixel(t,e,i){const r=this.tileSize*Math.pow(2,i),o=(t+180)/360*r,a=Math.sin(e*Math.PI/180),l=(.5-Math.log((1+a)/(1-a))/(4*Math.PI))*r;return{x:o,y:l}}pixelToLatLng(t,e,i){const r=this.tileSize*Math.pow(2,i),o=t/r,a=e/r,l=o*360-180,h=Math.PI-2*Math.PI*a,c=180/Math.PI*Math.atan(.5*(Math.exp(h)-Math.exp(-h)));return{lng:l,lat:c}}getTile(t,e,i){const r=Math.pow(2,t),o=(e%r+r)%r,a=Math.max(0,Math.min(r-1,i)),l=`${this.provider.key}/${t}/${o}/${a}`,h=this.cache.get(l);if(h)return h;const c={image:null,ready:!1,failed:!1,waiters:[]};this.cache.set(l,c);const m=this.buildUrl(t,o,a);return this.p.loadImage(m,g=>{c.image=g,c.ready=!0,c.failed=!1,this.resolve(c)},()=>{c.ready=!0,c.failed=!0,this.resolve(c)}),c}resolve(t){t.waiters.length&&(t.waiters.forEach(e=>e()),t.waiters=[])}buildUrl(t,e,i){let r=this.template.replace("{z}",String(t)).replace("{x}",String(e)).replace("{y}",String(i));if(r.includes("{s}")&&this.subdomains.length){const o=Math.abs((e+i)%this.subdomains.length);r=r.replace("{s}",this.subdomains[o])}return r.includes("{token}")&&(r=r.replace("{token}",encodeURIComponent(this.token))),r}}function xi(s){return s.ready?Promise.resolve():new Promise(t=>{s.waiters.push(t)})}const ne=25.4;function bi(s,t){const e=s==="portrait"?210:297,i=s==="portrait"?297:210;return{widthPx:Math.round(e/ne*t),heightPx:Math.round(i/ne*t)}}function yi(s){return s==="portrait"?210/297:297/210}async function wi(s,t,e,i){const r=t.getTileSize(),o=t.latLngToPixel(e.w,e.n,i),a=t.latLngToPixel(e.e,e.s,i),l=Math.floor(o.x/r),h=Math.floor(a.x/r),c=Math.floor(o.y/r),m=Math.floor(a.y/r),g=o.x,v=o.y,b=Math.max(1,Math.ceil(a.x-o.x)),u=Math.max(1,Math.ceil(a.y-o.y)),d=s.createGraphics(b,u);for(let p=c;p<=m;p+=1)for(let T=l;T<=h;T+=1){const P=t.getTile(i,T,p);if(await xi(P),P.ready&&P.image){const f=T*r-g,y=p*r-v;d.image(P.image,f,y,r,r)}}return d}async function zi(s,t,e,i){const{rows:r,cols:o,zoom:a,zoomDelta:l,orientation:h,dpi:c,filePrefix:m="map"}=i,g=Math.min(19,a+l),{widthPx:v,heightPx:b}=bi(h,c);for(let u=0;u<r;u+=1)for(let d=0;d<o;d+=1){const p=u*o+d,T=e[p],P=await wi(s,t,{n:T.n,s:T.s,w:T.w,e:T.e},g),f=s.createGraphics(v,b);f.image(P,0,0,v,b),Pi(f,Mi(d),u+1);const y=`${m}_${String(u+1).padStart(2,"0")}_${String(d+1).padStart(2,"0")}_${h}_z${g}.png`;s.save(f,y),await Si(140)}}function Si(s){return new Promise(t=>setTimeout(t,s))}function Mi(s){let t=Math.max(0,Math.floor(s)),e="";for(;t>=0;)e=String.fromCharCode(t%26+65)+e,t=Math.floor(t/26)-1;return e}function Pi(s,t,e){const i=`${t}${e}`,r=Math.max(14,Math.round(Math.min(s.width,s.height)*.02)),o=Math.round(r*.4),a=o,l=o+Math.round(r*.5);s.push(),s.textSize(r),s.textAlign(s.LEFT,s.TOP),s.textWidth(i),s.fill("#111"),s.text(i,a,l),s.pop()}function Vt(s,t,e,i){const r=s.latLngToPixel(t.lng,t.lat,e),o=r.x-i.width/2,a=r.y-i.height/2,l=o+i.width,h=a+i.height,c=s.pixelToLatLng(o,a,e),m=s.pixelToLatLng(l,h,e);return{zoom:e,pixelBounds:{left:o,top:a,width:i.width,height:i.height},latLngBounds:{n:c.lat,s:m.lat,w:c.lng,e:m.lng},centerPixel:r}}function Ti(s,t,e,i){const{zoom:r,pixelBounds:o}=t,a=o.width/i,l=o.height/e,h=[];for(let c=0;c<e;c+=1)for(let m=0;m<i;m+=1){const g=o.left+m*a,v=o.top+c*l,b=g+a,u=v+l,d=s.pixelToLatLng(g,v,r),p=s.pixelToLatLng(b,u,r);h.push({n:d.lat,s:p.lat,w:d.lng,e:p.lng,row:c,col:m})}return h}class Ei{constructor(t,e={}){this.target=t,this.options={rows:e.rows??2,cols:e.cols??3,zoom:e.zoom??15,zoomDelta:e.zoomDelta??0,orientation:e.orientation??"portrait",provider:e.provider??"osm",dpi:e.dpi??300,filePrefix:e.filePrefix??"map"},this.rows=this.options.rows,this.cols=this.options.cols,this.zoom=this.options.zoom,this.zoomDelta=this.options.zoomDelta,this.orientation=this.options.orientation,this.provider=this.options.provider,this.dpi=this.options.dpi,this.filePrefix=this.options.filePrefix??"map",this.p=null,this.p5Constructor=null,this.tileSystem=null,this.viewbox=null,this.center={lat:52.52,lng:13.405},this.stateSubscribers=new Set,this.shortcutListeners=new Set,this.viewport=null}async init(){if(!this.p){if(!this.p5Constructor){const t=await ii(()=>import("../chunks/DLNX37f0.js"),[],import.meta.url);this.p5Constructor=t.default}await new Promise(t=>{if(!this.p5Constructor)return t();this.p=new this.p5Constructor(e=>this.defineSketch(e,t),this.target)})}}defineSketch(t,e){t.setup=()=>{const i=this.target.getBoundingClientRect();t.createCanvas(Math.max(1,i.width),Math.max(1,i.height)),t.pixelDensity(1),this.tileSystem=new _i(t,this.provider),this.notifyState(),e()},t.windowResized=()=>{this.resize()},t.draw=()=>{this.render(t)},t.mouseDragged=()=>{this.handleDrag(t)},t.touchMoved=()=>(this.handleDrag(t),!1),t.keyPressed=()=>{t.key==="+"||t.key==="="?this.setZoom(this.zoom+1,t.width/2,t.height/2):(t.key==="-"||t.key==="_")&&this.setZoom(this.zoom-1,t.width/2,t.height/2)}}render(t){if(!this.tileSystem)return;t.background("azure");const e=this.computeGridFrame(t.width,t.height),i=Vt(this.tileSystem,this.center,this.zoom,e);this.applyViewport(i);const r=this.tileSystem.getTileSize(),{left:o,top:a,width:l,height:h}=i.pixelBounds,c=Math.floor(o/r),m=Math.floor((o+l)/r),g=Math.floor(a/r),v=Math.floor((a+h)/r),b=t.drawingContext;b.save(),b.beginPath(),b.rect(e.left,e.top,e.width,e.height),b.clip();for(let u=g;u<=v;u+=1)for(let d=c;d<=m;d+=1){const p=this.tileSystem.getTile(this.zoom,d,u);if(p.ready&&p.image){const T=d*r-o+e.left,P=u*r-a+e.top;t.image(p.image,T,P,r,r)}}b.restore(),this.drawGrid(t,e)}drawGrid(t,e){t.push(),t.stroke("blue"),t.noFill(),t.rect(e.left,e.top,e.width,e.height);const i=e.width/this.cols,r=e.height/this.rows,o=Math.min(18,Math.max(12,Math.min(i,r)*.12)),a=Math.round(o*.35);t.textSize(o),t.textAlign(t.LEFT,t.TOP);for(let l=0;l<=this.rows;l+=1){const h=e.top+l*r;t.line(e.left,h,e.left+e.width,h)}for(let l=0;l<=this.cols;l+=1){const h=e.left+l*i;t.line(h,e.top,h,e.top+e.height)}for(let l=0;l<this.rows;l+=1)for(let h=0;h<this.cols;h+=1){const c=`${this.getColumnLabel(h)}${l+1}`,m=e.left+h*i+a,g=e.top+l*r+a,v=t.textWidth(c);t.noStroke(),t.fill("blue"),t.rect(m-a,g-a,v+a*2,o+a*2),t.fill("white"),t.text(c,m,g)}t.pop()}handleDrag(t){if(!this.tileSystem||Array.isArray(t.touches)&&t.touches.length>1)return;const e=this.screenToWorld(t.mouseX,t.mouseY),i=this.screenToWorld(t.pmouseX,t.pmouseY);this.center.lat+=i.lat-e.lat,this.center.lng+=i.lng-e.lng,this.center.lat=this.clampLatitude(this.center.lat),this.center.lng=this.normalizeLongitude(this.center.lng),this.invalidateViewport()}setZoom(t,e,i){if(!this.tileSystem||!this.p)return;const r=Math.max(1,Math.min(19,t));if(r===this.zoom)return;const o=this.screenToWorld(e,i);this.zoom=r;const a=this.screenToWorld(e,i);this.center.lat+=o.lat-a.lat,this.center.lng+=o.lng-a.lng,this.invalidateViewport(),this.notifyState()}zoomBy(t){if(!this.p)return;const e=this.p.width/2,i=this.p.height/2;this.setZoom(this.zoom+t,e,i)}screenToWorld(t,e){if(!this.tileSystem||!this.p)return this.center;const i=this.computeGridFrame(this.p.width,this.p.height),r=this.tileSystem.latLngToPixel(this.center.lng,this.center.lat,this.zoom),o=t-i.left,a=e-i.top,l=r.x-i.width/2+o,h=r.y-i.height/2+a;return this.tileSystem.pixelToLatLng(l,h,this.zoom)}cycleProvider(){const t=gt.findIndex(i=>i.key===this.provider),e=gt[(t+1)%gt.length];this.setProvider(e.key)}resize(t,e){if(!this.p)return;const i=this.target.getBoundingClientRect(),r=Math.max(1,t??i.width),o=Math.max(1,e??i.height);this.p.resizeCanvas(r,o),this.invalidateViewport()}applyViewport(t){this.viewport=t,this.viewbox={...t.latLngBounds},this.notifyState()}invalidateViewport(){this.viewport=null,this.viewbox=null}updateViewbox(t){if(!this.tileSystem||!this.p)return;let e=t;if(!e){const i=this.computeGridFrame(this.p.width,this.p.height);e=Vt(this.tileSystem,this.center,this.zoom,i)}this.applyViewport(e)}async exportGrid(){if(!this.tileSystem||!this.p)return;let t=this.viewport;if(!t){const i=this.computeGridFrame(this.p.width,this.p.height);t=Vt(this.tileSystem,this.center,this.zoom,i),this.applyViewport(t)}const e=Ti(this.tileSystem,t,this.rows,this.cols);await zi(this.p,this.tileSystem,e,{rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,orientation:this.orientation,dpi:this.dpi,filePrefix:this.filePrefix})}setCenter(t,e,i){const r=this.clampLatitude(t),o=this.normalizeLongitude(e);this.center.lat=r,this.center.lng=o,typeof i=="number"&&(this.zoom=Math.max(1,Math.min(19,Math.round(i)))),this.invalidateViewport(),this.notifyState()}subscribe(t){return this.stateSubscribers.add(t),t(this.snapshot()),()=>{this.stateSubscribers.delete(t)}}onExportShortcut(t){return this.shortcutListeners.add(t),()=>{this.shortcutListeners.delete(t)}}triggerExportShortcut(){this.shortcutListeners.forEach(t=>t())}snapshot(){return{center:{...this.center},rows:this.rows,cols:this.cols,zoom:this.zoom,zoomDelta:this.zoomDelta,provider:this.provider,orientation:this.orientation,viewbox:this.viewbox?{...this.viewbox}:null}}notifyState(){const t=this.snapshot();this.stateSubscribers.forEach(e=>e(t))}setGrid(t,e){const i=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(e));i===this.rows&&r===this.cols||(this.rows=i,this.cols=r,this.invalidateViewport(),this.notifyState())}setZoomDelta(t){const e=Math.max(0,Math.round(t));e!==this.zoomDelta&&(this.zoomDelta=e,this.notifyState())}setOrientation(t){t!==this.orientation&&(this.orientation=t,this.invalidateViewport(),this.notifyState())}setProvider(t){t!==this.provider&&(this.provider=t,this.tileSystem&&this.tileSystem.setProvider(t),this.invalidateViewport(),this.notifyState())}setDpi(t){t!==this.dpi&&(this.dpi=t)}setFilePrefix(t){this.filePrefix=t}destroy(){this.p&&this.p.remove(),this.p=null,this.tileSystem=null,this.stateSubscribers.clear(),this.shortcutListeners.clear()}getCellRatio(){return yi(this.orientation)}computeGridFrame(t,e){const i=this.getCellRatio(),r=this.cols*i/Math.max(1,this.rows);let o=t,a=o/r;a>e&&(a=e,o=a*r);const l=(t-o)/2,h=(e-a)/2;return{left:l,top:h,width:o,height:a}}clampLatitude(t){return Math.max(-85,Math.min(85,t))}normalizeLongitude(t){let e=t%360;return e>180&&(e-=360),e<-180&&(e+=360),e}getColumnLabel(t){let e=Math.max(0,Math.floor(t)),i="";for(;e>=0;)i=String.fromCharCode(e%26+65)+i,e=Math.floor(e/26)-1;return i}}var Li=B('<div class="map-canvas svelte-4tz69q"><div class="zoom-controls svelte-4tz69q" aria-label="Map zoom controls"><button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom in">+</button> <button type="button" class="zoom-btn svelte-4tz69q" aria-label="Zoom out">-</button></div></div>');function Ci(s,t){ve(t,!0);const e=N(t,"rows",3,2),i=N(t,"cols",3,3),r=N(t,"zoomDelta",3,0),o=N(t,"orientation",3,"portrait"),a=N(t,"provider",3,"osm"),l=N(t,"dpi",3,300),h=N(t,"filePrefix",3,"map"),c=me();let m=null,g=null,v=null;ri(()=>{if(!m)return;const L=new Ei(m,{rows:e(),cols:i(),zoomDelta:r(),orientation:o(),provider:a(),dpi:l(),filePrefix:h()}),I=[];return L.init().then(()=>c("ready",L)),I.push(L.subscribe(k=>c("state",k))),I.push(L.onExportShortcut(()=>c("exportshortcut"))),v=new ResizeObserver(k=>{if(!k.length)return;const{width:A,height:Y}=k[0].contentRect;L.resize(A,Y)}),v.observe(m),g=L,()=>{I.forEach(k=>k()),v?.disconnect(),L.destroy(),g=null}}),si(()=>{v?.disconnect()}),et(()=>{g&&g.setGrid(e(),i())}),et(()=>{g&&g.setZoomDelta(r())}),et(()=>{g&&g.setOrientation(o())}),et(()=>{g&&g.setProvider(a())}),et(()=>{g&&g.setDpi(l())}),et(()=>{g&&g.setFilePrefix(h())});function b(){g?.zoomBy(1)}function u(){g?.zoomBy(-1)}async function d(){g&&await g.exportGrid()}function p(L,I,k){g?.setCenter(L,I,k)}var T={exportGrid:d,focusOn:p},P=Li(),f=w(P),y=w(f);y.__click=b;var E=M(y,2);return E.__click=u,x(f),x(P),fe(P,L=>m=L,()=>m),G(s,P),pe(T)}ge(["click"]);var Di=B('<main class="page svelte-1uha8ag"><section class="panel svelte-1uha8ag"><!></section> <section class="canvas svelte-1uha8ag"><!></section></main>');function Fi(s){let t=W(2),e=W(2),i=W(0),r=W("portrait"),o=W("osm"),a=W(300),l=W("map"),h=W(!1),c=W(null),m=W(null);function g(f){const y=f.detail;typeof y.rows=="number"&&C(t,y.rows),typeof y.cols=="number"&&C(e,y.cols),typeof y.zoomDelta=="number"&&C(i,y.zoomDelta),y.orientation&&C(r,y.orientation),y.provider&&C(o,y.provider),typeof y.dpi=="number"&&C(a,y.dpi),y.filePrefix&&C(l,y.filePrefix)}async function v(){if(!(!_(c)||_(h))){C(h,!0);try{await _(c).exportGrid()}catch(f){console.error(f)}C(h,!1)}}function b(f){if(!_(c))return;const{lat:y,lng:E,zoom:L}=f.detail;_(c).focusOn(y,E,L)}var u=Di(),d=w(u),p=w(d);{let f=mt(()=>_(m)?.zoom??15),y=mt(()=>_(m)?.viewbox??null),E=mt(()=>_(m)?.center??null);gi(p,{get rows(){return _(t)},get cols(){return _(e)},get zoomDelta(){return _(i)},get orientation(){return _(r)},get provider(){return _(o)},get zoom(){return _(f)},get viewbox(){return _(y)},get center(){return _(E)},get isExporting(){return _(h)},get dpi(){return _(a)},get filePrefix(){return _(l)},$$events:{change:g,export:v,locate:b}})}x(d);var T=M(d,2),P=w(T);fe(Ci(P,{get rows(){return _(t)},get cols(){return _(e)},get zoomDelta(){return _(i)},get orientation(){return _(r)},get provider(){return _(o)},get dpi(){return _(a)},get filePrefix(){return _(l)},$$events:{state:f=>C(m,f.detail),exportshortcut:v},$$legacy:!0}),f=>C(c,f),()=>_(c)),x(T),x(u),G(s,u)}export{Fi as component};
